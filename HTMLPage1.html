<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>问诊助手</title>
    <style>
        /* 基础样式 */
        * {
            box-sizing: border-box;
        }
        
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 15px; 
            line-height: 1.6;
            background-color: #f5f5f5;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .section { 
            background: white;
            border: 1px solid #ddd; 
            padding: 16px; 
            margin-bottom: 15px; 
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section h2 { 
            margin-top: 0; 
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        
        .hidden { 
            display: none; 
        }
        
        /* 折叠功能样式 */
        .section h2 {
            cursor: default;
            user-select: none;
            position: relative;
            padding-right: 30px;
            transition: background-color 0.2s ease;
            /* 移动端触摸优化 */
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            touch-action: manipulation;
            min-height: 44px; /* iOS建议的最小触摸目标 */
            display: flex;
            align-items: center;
        }
        
        .section h2:hover {
            background-color: rgba(52, 152, 219, 0.02);
        }
        
        .section h2:active {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .section h2::after {
            content: '▼';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.3s ease;
            font-size: 12px;
            color: #3498db;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background-color: rgba(52, 152, 219, 0.1);
            cursor: pointer;
        }
        
        .section h2::after:hover {
            background-color: rgba(52, 152, 219, 0.2);
        }
        
        .section.collapsed h2::after {
            transform: translateY(-50%) rotate(-90deg);
        }
        
        .section.collapsed .section-content {
            display: none !important;
        }
        
        .section-content {
            transition: all 0.3s ease;
        }
        
        .form-row { 
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }
        
        label { 
            font-weight: bold;
            color: #555;
            min-width: 80px;
            flex-shrink: 0;
        }
        
        input[type="text"], 
        input[type="number"], 
        input[type="tel"],
        select, 
        textarea {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            transition: border-color 0.3s ease;
        }
        
        input[type="text"]:focus, 
        input[type="number"]:focus, 
        input[type="tel"]:focus,
        select:focus, 
        textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        
        textarea {
            width: 100%;
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }
        
        /* 疾病史用药详情样式 */
        .form-row span div {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #27ae60;
        }
        
        .form-row span div input {
            flex: 1;
            min-width: 150px;
        }
        
        select {
            cursor: pointer;
            background-color: white;
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
                margin-bottom: 15px;
            }
            
            .section {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .section h2 {
                font-size: 16px;
                margin-bottom: 12px;
                padding: 8px 35px 8px 8px;
                border-radius: 4px;
                min-height: 48px; /* 增加触摸目标大小 */
            }
            
            .section h2::after {
                font-size: 14px;
                right: 8px;
                width: 28px;
                height: 28px;
            }
            
            .form-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
                margin-bottom: 12px;
            }
            
            .form-row > strong {
                width: 100%;
                margin-bottom: 8px;
                color: #2c3e50;
                font-size: 14px;
            }
            
            .form-row > span {
                width: 100%;
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
                align-items: center;
            }
            
            label {
                min-width: 60px;
                font-size: 13px;
            }
            
            input[type="text"], 
            input[type="number"], 
            input[type="tel"],
            select {
                flex: 1;
                min-width: 120px;
                padding: 10px 12px;
                font-size: 16px; /* 防止iOS缩放 */
                min-height: 44px; /* 确保触摸友好 */
            }
            
            textarea {
                font-size: 16px; /* 防止iOS缩放 */
                padding: 10px 12px;
                min-height: 44px;
            }
            
            /* 隐藏元素在移动端的显示优化 */
            .hidden {
                display: none !important;
            }
            
            /* 移动端详情展示区域样式优化 - 不强制隐藏，让JavaScript控制显示 */
            span[id$="-detail"]:not(.hidden),
            span[id$="-info"]:not(.hidden),
            span[id$="-history"]:not(.hidden),
            span[id$="-area"]:not(.hidden),
            span[id$="-exposure"]:not(.hidden),
            span[id$="-dependence"]:not(.hidden),
            span[id$="-abuse"]:not(.hidden),
            span[id$="-abortion"]:not(.hidden),
            span[id$="-health"]:not(.hidden),
            span[id$="-test"]:not(.hidden),
            span[id$="-plan"]:not(.hidden),
            span[id*="relief-"]:not(.hidden),
            span[id*="options"]:not(.hidden) {
                display: block !important;
                width: 100%;
                margin-top: 8px;
                padding: 8px;
                background-color: #f8f9fa;
                border-radius: 4px;
                border-left: 3px solid #3498db;
            }
            
            /* 确保折叠功能在移动端正常工作 */
            .section.collapsed .section-content {
                display: none !important;
                opacity: 0;
                transform: translateY(-10px);
            }
            
            .section:not(.collapsed) .section-content {
                display: block !important;
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* 超小屏幕适配 */
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }
            
            .section {
                padding: 10px;
                margin-bottom: 10px;
            }
            
            .form-row {
                gap: 4px;
                margin-bottom: 10px;
            }
            
            input[type="text"], 
            input[type="number"], 
            input[type="tel"],
            select {
                min-width: 100px;
                padding: 8px 10px;
            }
            
            label {
                min-width: 50px;
                font-size: 12px;
            }
            
            /* 移动端用药详情样式 */
            .form-row span div {
                flex-direction: column;
                gap: 6px;
                padding: 6px;
                margin-top: 6px;
            }
            
            .form-row span div input {
                min-width: auto;
                width: 100%;
            }
        }
          /* 触摸友好的按钮和选择器 */
        button {
            transition: background-color 0.3s ease;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        @media (hover: none) and (pointer: coarse) {
            select, 
            input[type="text"], 
            input[type="number"], 
            input[type="tel"] {
                min-height: 44px; /* iOS建议的最小触摸目标 */
            }
            
            button {
                min-height: 44px;
                padding: 12px 20px;
                margin: 5px;
                width: auto;
                min-width: 100px;
            }
        }
        
        /* 移动端按钮布局 */
        @media (max-width: 480px) {
            .section[style*="text-align: center"] {
                text-align: center;
            }
            
            .section button {
                display: inline-block;
                width: 45%;
                margin: 5px 1%;
                padding: 10px 6px;
                font-size: 12px;
            }
        }
        
        /* 打印样式 */
        @media print {
            body {
                background-color: white;
                padding: 0;
                font-size: 12px;
            }
            
            .section {
                box-shadow: none;
                border: 1px solid #000;
                margin-bottom: 10px;
                page-break-inside: avoid;
            }
            
            .section:last-child {
                display: none; /* 隐藏操作按钮 */
            }
            
            h1, .section h2 {
                color: black;
                border-bottom: 1px solid #000;
            }
            
            input, select, textarea {
                border: none;
                border-bottom: 1px solid #000;
                background: transparent;
                print-color-adjust: exact;
            }
            
            .hidden {
                display: none !important;
            }
        }
        
        /* 移动端疾病史详情特殊处理 */
        span[id$="-detail"] div {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }
        
        span[id$="-detail"] div input,
        span[id$="-detail"] div select,
        span[id$="-detail"] div textarea {
            width: 100%;
            margin-bottom: 5px;
        }
        
        /* 确保条件显示元素在移动端正确布局 */
        @media (max-width: 768px) {
            span[id$="-detail"]:not(.hidden),
            span[id$="-info"]:not(.hidden),
            span[id$="-area"]:not(.hidden),
            span[id$="-exposure"]:not(.hidden),
            span[id$="-history"]:not(.hidden) {
                display: block !important;
                width: 100% !important;
                box-sizing: border-box;
            }
        }
    </style>
    <script>
        function toggleDisplay(id, value, showValue = "有") {
            const element = document.getElementById(id);
            if (element) {
                if (value === showValue) {
                    element.style.display = "block";
                    element.classList.remove('hidden');
                } else {
                    element.style.display = "none";
                    element.classList.add('hidden');
                }
            }
        }
        function onGenderChange(sel) {
            const menstrualHistory = document.getElementById('menstrual-history');
            
            // 查找生育史模块 - 通过查找包含"生育史"标题的section
            const fertilitySection = Array.from(document.querySelectorAll('.section')).find(section => {
                const h2 = section.querySelector('h2');
                return h2 && h2.textContent.trim() === '生育史';
            });
            
            if (sel.value === "女") {
                // 显示月经史
                if (menstrualHistory) {
                    menstrualHistory.style.display = "block";
                    menstrualHistory.classList.remove('hidden');
                }
                
                // 显示生育史模块
                if (fertilitySection) {
                    fertilitySection.style.display = "block";
                    fertilitySection.classList.remove('hidden');
                }
            } else {
                // 隐藏月经史
                if (menstrualHistory) {
                    menstrualHistory.style.display = "none";
                    menstrualHistory.classList.add('hidden');
                }
                
                // 隐藏生育史模块
                if (fertilitySection) {
                    fertilitySection.style.display = "none";
                    fertilitySection.classList.add('hidden');
                    
                    // 同时重置生育史相关的表单项
                    const fertilityInputs = fertilitySection.querySelectorAll('input, select, textarea');
                    fertilityInputs.forEach(input => {
                        if (input.type === 'checkbox' || input.type === 'radio') {
                            input.checked = false;
                        } else {
                            input.value = '';
                            if (input.selectedIndex !== undefined) {
                                input.selectedIndex = 0;
                            }
                        }
                    });
                    
                    // 隐藏生育史相关的动态显示内容
                    const fertilityDetails = [
                        'fertility-history', 'spontaneous-abortion', 'induced-abortion', 
                        'delivery-detail', 'newborn-health', 'breastfeeding', 'contraception', 
                        'infertility', 'assisted-reproduction', 'spouse-fertility'
                    ];
                    fertilityDetails.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            element.classList.add('hidden');
                        }
                    });
                }
            }
        }
        function onReliefChange(sel) {
            let val = sel.value;
            document.getElementById('relief-rest').style.display = (val === "休息") ? "inline" : "none";
            document.getElementById('relief-medicine').style.display = (val === "服药") ? "inline" : "none";
            document.getElementById('relief-other').style.display = (val === "其他") ? "inline" : "none";
        }
        function onSymptomReliefChange(sel) {
            let val = sel.value;
            document.getElementById('relief-options').style.display = (val === "有") ? "inline" : "none";
            document.getElementById('no-relief').style.display = (val === "无") ? "inline" : "none";
        }
        
        // 动态生成药物输入框
        function generateDrugInputs(count) {
            const container = document.getElementById('drug-inputs-container');
            container.innerHTML = ''; // 清空现有内容
            
            if (count == 0) {
                container.innerHTML = '<div class="form-row"><em>患者未使用任何药物</em></div>';
                return;
            }
            
            for (let i = 1; i <= count; i++) {
                const drugRow = document.createElement('div');
                drugRow.className = 'form-row';
                drugRow.innerHTML = `
                    <label>第${i}种药物</label>
                    <input type="text" placeholder="药物名称" name="drug${i}_name">
                    <input type="text" placeholder="剂量规格" name="drug${i}_dose">
                    <input type="text" placeholder="用法用量" name="drug${i}_usage">
                    <input type="text" placeholder="用药时间" name="drug${i}_duration">
                    <select name="drug${i}_effect">
                        <option>有效</option>
                        <option>无效</option>
                        <option>部分有效</option>
                        <option>不详</option>
                    </select>
                `;
                container.appendChild(drugRow);
            }
            
            // 如果有多种药物，添加药物相互作用和依从性评估
            if (count > 1) {
                const interactionRow = document.createElement('div');
                interactionRow.className = 'form-row';
                interactionRow.innerHTML = `
                    <label>药物相互作用</label>
                    <select name="drug_interaction">
                        <option>无明显相互作用</option>
                        <option>有轻微相互作用</option>
                        <option>有明显相互作用</option>
                        <option>不详</option>
                    </select>
                    <label>服药依从性</label>
                    <select name="drug_compliance">
                        <option>按时按量服药</option>
                        <option>偶尔漏服</option>
                        <option>经常漏服</option>
                        <option>自行调整剂量</option>
                        <option>已停药</option>
                    </select>
                `;
                container.appendChild(interactionRow);
            } else if (count == 1) {
                const complianceRow = document.createElement('div');
                complianceRow.className = 'form-row';
                complianceRow.innerHTML = `
                    <label>服药依从性</label>
                    <select name="drug_compliance">
                        <option>按时按量服药</option>
                        <option>偶尔漏服</option>
                        <option>经常漏服</option>
                        <option>自行调整剂量</option>
                        <option>已停药</option>
                    </select>
                `;
                container.appendChild(complianceRow);
            }
        }
        
        // 为疾病生成药物输入框
        function generateDiseaseInputs(disease, count) {
            const container = document.getElementById(disease + '-drug-container');
            if (!container) return;
            
            container.innerHTML = ''; // 清空现有内容
            
            if (count == 0) {
                container.innerHTML = '<div style="margin-top: 5px;"><em>未用药治疗</em></div>';
                return;
            }
            
            for (let i = 1; i <= count; i++) {
                const drugRow = document.createElement('div');
                drugRow.style.marginTop = '5px';
                drugRow.innerHTML = `
                    <input type="text" placeholder="药物名称" style="margin: 2px;">
                    <input type="text" placeholder="剂量规格" style="margin: 2px;">
                    <input type="text" placeholder="用药效果" style="margin: 2px;">
                `;
                container.appendChild(drugRow);
            }
        }
        
        // 添加折叠功能
        function toggleSection(element) {
            const section = element.closest('.section');
            const isCollapsed = section.classList.contains('collapsed');
            
            if (isCollapsed) {
                // 展开
                section.classList.remove('collapsed');
                // 确保内容显示
                const content = section.querySelector('.section-content');
                if (content) {
                    content.style.display = 'block';
                }
            } else {
                // 折叠
                section.classList.add('collapsed');
                // 确保内容隐藏
                const content = section.querySelector('.section-content');
                if (content) {
                    content.style.display = 'none';
                }
            }
            
            // 强制重绘
            section.offsetHeight;
        }
        
        // 为新增的toggleDisplay元素添加支持
        function setupToggleDisplays() {
            // 获取所有需要隐藏/显示的元素ID列表
            const toggleIds = [
                // 月经史
                'menopause-info',
                // 家族史
                'father-health', 'mother-health', 'family-disease', 'siblings-health',
                // 系统回顾
                'weight-change', 'fever-detail', 'fatigue-detail', 'sweats-detail',
                'cough-detail', 'sputum-detail', 'hemoptysis-detail', 'chest-pain-detail', 'dyspnea-detail',
                'palpitation-detail', 'chest-tightness-detail', 'edema-system-detail', 'cyanosis-detail',
                'appetite-detail', 'nausea-detail', 'vomiting-detail', 'abdominal-pain-detail', 'diarrhea-detail', 'constipation-detail',
                'urinary-frequency-detail', 'urinary-urgency-detail', 'dysuria-detail', 'hematuria-detail', 'nocturia-detail',
                'headache-detail', 'dizziness-detail', 'insomnia-detail', 'memory-loss-detail', 'numbness-detail',
                // 既往史
                'hypertension-detail', 'diabetes-detail', 'heart-disease-detail', 'stroke-detail',
                'liver-disease-detail', 'kidney-disease-detail', 'cancer-detail', 'other-chronic-detail',
                'hepatitis-detail', 'tuberculosis-detail', 'other-infection-detail',
                'surgery-history-detail', 'trauma-detail', 'transfusion-detail',
                'drug-allergy-detail', 'food-allergy-detail', 'other-allergy-detail', 'vaccination-detail',
                // 个人史
                'schistosomiasis-area', 'endemic-area', 'epidemic-area',
                'toxic-exposure', 'dust-exposure', 'radiation-exposure', 'noise-exposure',
                'smoking-detail', 'drinking-detail', 'drug-dependence', 'drug-abuse',
                'sexual-history', 'std-history',
                // 生育史
                'fertility-history', 'spontaneous-abortion', 'induced-abortion', 'delivery-detail', 'newborn-health',
                'breastfeeding', 'contraception', 'infertility', 'assisted-reproduction', 'spouse-fertility',
                // 体格检查详情
                'edema-detail', 'rash-detail', 'lymph-detail', 'tenderness-detail', 
                'liver-detail', 'spleen-detail', 'muscle-strength-detail', 'joint-detail',
                // 辅助检查
                'blood-test', 'urine-test', 'liver-test', 'kidney-test', 
                'xray-test', 'ct-test', 'mri-test', 'ultrasound-test',
                // 症状缓解相关
                'relief-rest', 'relief-medicine', 'relief-other', 'relief-options', 'no-relief'
            ];
            
            // 确保所有toggle元素初始状态为隐藏
            toggleIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                    element.classList.add('hidden');
                }
            });
            
            // 初始化性别相关的显示控制
            const genderSelect = document.querySelector('[name="patient_gender"]');
            if (genderSelect) {
                // 初始隐藏月经史和生育史（默认状态）
                const menstrualHistory = document.getElementById('menstrual-history');
                const fertilitySection = Array.from(document.querySelectorAll('.section')).find(section => {
                    const h2 = section.querySelector('h2');
                    return h2 && h2.textContent.trim() === '生育史';
                });
                
                if (menstrualHistory) {
                    menstrualHistory.style.display = 'none';
                    menstrualHistory.classList.add('hidden');
                }
                
                if (fertilitySection) {
                    fertilitySection.style.display = 'none';
                    fertilitySection.classList.add('hidden');
                }
                
                // 如果性别已经选择，应用相应的显示逻辑
                if (genderSelect.value) {
                    onGenderChange(genderSelect);
                }
            }
        }
        
        function saveForm() {
            // 获取所有表单数据
            const formData = {};
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.name || input.placeholder) {
                    const key = input.name || input.placeholder;
                    formData[key] = input.value;
                }
            });
            
            // 特别保存药物数量选择
            const drugCountSelect = document.getElementById('drug-count-select');
            if (drugCountSelect) {
                formData['drug_count'] = drugCountSelect.value;
            }
            
            // 保存到本地存储
            localStorage.setItem('consultationForm', JSON.stringify(formData));
            alert('表单已保存到本地存储！');
        }
        
        function clearForm() {
            if (confirm('确定要清空所有内容吗？')) {
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'text' || input.type === 'number' || input.type === 'tel' || input.type === 'date' || input.type === 'datetime-local') {
                        input.value = '';
                    } else if (input.type === 'select-one') {
                        input.selectedIndex = 0;
                    } else if (input.tagName === 'TEXTAREA') {
                        input.value = '';
                    }
                });
                
                // 重置药物数量选择
                const drugCountSelect = document.getElementById('drug-count-select');
                if (drugCountSelect) {
                    drugCountSelect.value = '0';
                    generateDrugInputs(0);
                }
                
                // 隐藏所有条件显示的元素
                const hiddenElements = document.querySelectorAll(`
                    .hidden, [id="menstrual-history"],
                    [id*="menopause-"], [id*="father-"], [id*="mother-"], [id*="family-"], [id*="siblings-"],
                    [id*="weight-"], [id*="hypertension-"], [id*="diabetes-"], [id*="heart-disease-"], [id*="stroke-"],
                    [id*="liver-disease-"], [id*="kidney-disease-"], [id*="cancer-"], [id*="chronic-"],
                    [id*="hepatitis-"], [id*="tuberculosis-"], [id*="infection-"], [id*="surgery-history-"],
                    [id*="trauma-"], [id*="transfusion-"], [id*="allergy-"], [id*="vaccination-"],
                    [id*="schistosomiasis-"], [id*="endemic-"], [id*="epidemic-"], [id*="toxic-"], [id*="dust-"],
                    [id*="radiation-"], [id*="noise-"], [id*="smoking-"], [id*="drinking-"], [id*="drug-dependence"],
                    [id*="drug-abuse"], [id*="sexual-"], [id*="std-"], [id*="abortion"], [id*="delivery-"],
                    [id*="newborn-"], [id*="breastfeeding"], [id*="contraception"], [id*="infertility"],
                    [id*="assisted-"], [id*="spouse-"], [id*="blood-"], [id*="urine-"], [id*="liver-test"],
                    [id*="kidney-test"], [id*="xray-"], [id*="ct-"], [id*="mri-"], [id*="ultrasound-"], [id*="surgery-plan"]
                `);
                hiddenElements.forEach(element => {
                    element.style.display = 'none';
                });
                
                localStorage.removeItem('consultationForm');
                alert('表单已清空！');
            }
        }
        
        // 页面加载时恢复保存的数据
        window.addEventListener('load', function() {
            // 初始化toggle显示状态
            setupToggleDisplays();
            
            // 初始化折叠功能
            initializeCollapsibleSections();
            
            // 移动端兼容性增强
            enhanceMobileCompatibility();
            
            // 初始化药物输入框（默认显示"未用药"）
            generateDrugInputs(0);
            
            const savedData = localStorage.getItem('consultationForm');
            if (savedData) {
                try {
                    const formData = JSON.parse(savedData);
                    
                    // 先恢复药物数量选择
                    if (formData['drug_count']) {
                        const drugCountSelect = document.getElementById('drug-count-select');
                        if (drugCountSelect) {
                            drugCountSelect.value = formData['drug_count'];
                            generateDrugInputs(formData['drug_count']);
                        }
                    }
                    
                    // 恢复其他表单数据
                    Object.keys(formData).forEach(key => {
                        if (key !== 'drug_count') {
                            const input = document.querySelector(`[name="${key}"], [placeholder="${key}"]`);
                            if (input && formData[key]) {
                                input.value = formData[key];
                                
                                // 如果是性别选择，触发性别变化事件
                                if (key === 'patient_gender') {
                                    onGenderChange(input);
                                }
                                
                                // 触发其他change事件以显示相关的动态内容
                                if (input.onchange) {
                                    input.onchange();
                                }
                            }
                        }
                    });
                } catch (e) {
                    console.error('恢复表单数据时出错:', e);
                }
            }
        });
        
        // 初始化折叠功能
        function initializeCollapsibleSections() {
            const sectionHeaders = document.querySelectorAll('.section h2');
            sectionHeaders.forEach(header => {
                // 移除标题的点击事件，只保留折叠按钮的事件
                header.style.cursor = 'default';
                
                // 为折叠按钮添加点击事件
                header.addEventListener('click', function(e) {
                    // 只有点击在右侧按钮区域时才触发折叠
                    const rect = this.getBoundingClientRect();
                    const clickX = e.clientX;
                    const rightEdge = rect.right;
                    
                    // 检测是否为移动端
                    const isMobile = window.innerWidth <= 768;
                    const buttonWidth = isMobile ? 28 : 24; // 移动端按钮更大
                    const clickTolerance = isMobile ? 15 : 10; // 移动端点击容差更大
                    
                    // 判断是否点击在折叠按钮区域
                    if (clickX >= rightEdge - buttonWidth - clickTolerance) {
                        e.preventDefault();
                        e.stopPropagation();
                        toggleSection(this);
                    }
                });
                
                // 为移动端添加触摸事件支持
                header.addEventListener('touchend', function(e) {
                    // 获取触摸点位置
                    if (e.changedTouches && e.changedTouches.length > 0) {
                        const touch = e.changedTouches[0];
                        const rect = this.getBoundingClientRect();
                        const touchX = touch.clientX;
                        const rightEdge = rect.right;
                        
                        // 移动端使用更大的按钮区域和容差
                        const buttonWidth = 28;
                        const touchTolerance = 15;
                        
                        // 判断是否触摸在折叠按钮区域
                        if (touchX >= rightEdge - buttonWidth - touchTolerance) {
                            e.preventDefault();
                            e.stopPropagation();
                            toggleSection(this);
                        }
                    }
                });
                
                // 确保标题可以被触摸
                header.style.touchAction = 'manipulation';
                header.style.webkitTouchCallout = 'none';
                header.style.webkitUserSelect = 'none';
                header.style.userSelect = 'none';
            });
        }
        
        // 手动恢复数据功能
        function restoreForm() {
            const savedData = localStorage.getItem('consultationForm');
            if (savedData) {
                if (confirm('确定要恢复保存的数据吗？当前内容将被覆盖。')) {
                    location.reload(); // 重新加载页面来恢复数据
                }
            } else {
                alert('没有找到保存的数据！');
            }
        }
        
        // 加载常用模板
        function loadTemplate() {
            const templates = {
                '常规门诊模板': {
                    'patient_gender': '男',
                    'patient_age': '45',
                    'marital_status': '已婚',
                    'patient_ethnicity': '汉族',
                    'insurance_type': '城镇职工基本医疗保险',
                    'history_source': '患者本人',
                    'history_reliability': '可靠',
                    'record_type': '门诊病历'
                },
                '急诊模板': {
                    'record_type': '急诊病历',
                    'history_source': '患者本人',
                    'history_reliability': '基本可靠',
                    'rest_requirement': '适当休息',
                    'diet_requirement': '普通饮食'
                },
                '住院模板': {
                    'record_type': '住院病历',
                    'history_source': '患者本人+家属补充',
                    'history_reliability': '可靠',
                    'rest_requirement': '卧床休息',
                    'diet_requirement': '软食'
                }
            };
            
            const templateNames = Object.keys(templates);
            const selectedTemplate = prompt('请选择模板：\n' + templateNames.map((name, index) => `${index + 1}. ${name}`).join('\n') + '\n\n请输入数字选择:');
            
            if (selectedTemplate && selectedTemplate >= 1 && selectedTemplate <= templateNames.length) {
                const templateName = templateNames[selectedTemplate - 1];
                const templateData = templates[templateName];
                
                // 应用模板数据
                Object.keys(templateData).forEach(key => {
                    const input = document.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.value = templateData[key];
                    }
                });
                
                alert(`已加载"${templateName}"模板！`);
            }
        }
        
        // 添加导出功能
        function exportToWord() {
            try {
                // 获取表单数据
                const formData = {};
                const inputs = document.querySelectorAll('input, select, textarea');
                
                if (inputs.length === 0) {
                    alert('未找到表单数据，请检查页面是否正常加载。');
                    return;
                }
            
            // 字段中文映射
            const fieldNames = {
                // 基本信息
                'patient_name': '患者姓名',
                'patient_gender': '性别',
                'patient_age': '年龄',
                'patient_ethnicity': '民族',
                'marital_status': '婚姻状况',
                'birth_place': '出生地',
                'current_address': '现住址',
                'patient_occupation': '职业',
                'patient_workplace': '工作单位',
                'admission_date': '入院日期',
                'record_date': '记录日期',
                'emergency_contact_name': '紧急联系人姓名',
                'emergency_contact_relation': '与患者关系',
                'emergency_contact_phone': '联系电话',
                'history_source': '病史来源',
                'history_reliability': '可靠程度',
                
                // 主诉和现病史
                'chief_complaint': '主诉',
                '具体日期/时间': '起病时间',
                '明确诱因/无明显诱因': '诱因',
                '症状发生部位': '部位',
                '疼痛性质、咳嗽特点等': '性质',
                '持续时间/间歇性': '持续时间',
                '发作频率': '频度',
                '休息、药物、体位等': '缓解因素',
                '活动、情绪、饮食等': '加重因素',
                '症状变化过程、新症状出现、病情进展情况': '演变过程',
                '与主症状同时出现的其他症状': '伴随症状',
                '就诊医院名称': '就诊医院',
                '已做检查项目': '检查项目',
                '医生诊断': '诊断结果',
                '增加/减少多少kg': '体重变化',
                
                // 生命体征
                'temperature': '体温',
                'pulse': '脉搏',
                'respiration': '呼吸',
                'blood_pressure': '血压',
                'height': '身高',
                'weight': '体重',
                
                // 既往史相关
                'drug_interaction': '药物相互作用',
                'drug_compliance': '用药依从性',
                '确诊时间': '确诊时间',
                '最高血压值': '最高血压值',
                '治疗情况': '治疗情况',
                '血糖控制情况': '血糖控制情况',
                '治疗方案': '治疗方案',
                '具体疾病名称': '具体疾病名称',
                '发病时间': '发病时间',
                '病变部位': '病变部位',
                '后遗症': '后遗症',
                '具体病名': '具体病名',
                '治疗经过': '治疗经过',
                '用药名称(如护肝药、抗病毒药等)': '用药名称',
                '用药剂量': '用药剂量',
                '肝功能改善情况': '肝功能改善情况',
                '肾功能情况': '肾功能情况',
                '用药名称(如ACEI/ARB、利尿剂等)': '肾病用药名称',
                '肾功能保护效果': '肾功能保护效果',
                '肿瘤类型': '肿瘤类型',
                '化疗/靶向药物名称': '化疗药物名称',
                '治疗效果': '治疗效果',
                '其他慢性疾病详情': '其他疾病详情',
                '肝炎类型': '肝炎类型',
                '患病时间': '患病时间',
                '抗病毒药物名称': '抗病毒药物名称',
                '用药方案': '用药方案',
                '病毒载量/转氨酶变化': '病毒载量变化',
                '结核部位': '结核部位',
                '抗结核药物名称': '抗结核药物名称',
                '手术名称': '手术名称',
                '手术时间': '手术时间',
                '手术医院': '手术医院',
                '麻醉方式': '麻醉方式',
                
                // 个人史
                'smoking_history': '吸烟史',
                'smoking_amount': '吸烟量',
                'drinking_history': '饮酒史',
                'drinking_amount': '饮酒量',
                'exercise_habit': '运动习惯',
                'sleep_quality': '睡眠质量',
                'diet_preference': '饮食偏好',
                'living_environment': '居住环境',
                'exposure_history': '接触史',
                
                // 生育史
                'has_fertility_history': '是否有过生育经历',
                'pregnancy_times': '怀孕次数',
                'birth_times': '分娩次数',
                'abortion_times': '流产次数',
                'delivery_type': '分娩方式',
                'delivery_complications': '分娩并发症',
                'lactation_period': '哺乳期',
                'contraception_method': '避孕方式',
                'menstrual_cycle': '月经周期',
                'menstrual_duration': '月经持续时间',
                'menstrual_amount': '月经量',
                'last_menstrual_period': '末次月经',
                'menarche_age': '初潮年龄',
                'menopause_age': '绝经年龄',
                
                // 体格检查 - 一般状态
                'development': '发育状况',
                'nutrition': '营养状况',
                'consciousness': '意识状态',
                'mental_state': '精神状态',
                'body_position': '体位',
                'gait': '步态',
                
                // 体格检查 - 皮肤黏膜
                'skin_color': '皮肤颜色',
                'skin_elasticity': '皮肤弹性',
                'rash': '皮疹',
                'rash_type': '皮疹类型',
                'rash_distribution': '皮疹分布',
                'rash_location': '皮疹部位',
                '具体部位描述': '皮疹具体部位',
                'edema': '水肿',
                'edema_location': '水肿部位',
                'edema_degree': '水肿程度',
                'edema_nature': '水肿性质',
                
                // 体格检查 - 淋巴结
                'lymph_nodes': '浅表淋巴结',
                'lymph_location': '淋巴结部位',
                'lymph_size': '淋巴结大小',
                'lymph_texture': '淋巴结质地',
                'lymph_mobility': '淋巴结活动度',
                'lymph_tenderness': '淋巴结压痛',
                
                // 体格检查 - 头颈部
                'head': '头颅',
                'eyes': '眼部',
                'ent': '耳鼻喉',
                'neck': '颈部',
                
                // 体格检查 - 胸部
                'chest_shape': '胸廓',
                'breathing': '呼吸运动',
                'breath_sounds': '呼吸音',
                'rales': '啰音',
                
                // 体格检查 - 心脏
                'heart_border': '心界',
                'heart_rate': '心率',
                'heart_sounds': '心音',
                'murmur': '心脏杂音',
                
                // 体格检查 - 腹部
                'abdomen_shape': '腹部外观',
                'abdominal_veins': '腹壁静脉',
                'abdomen_palpation': '腹部触诊',
                'tenderness': '压痛',
                'tenderness_location': '压痛部位',
                'liver_size': '肝脏大小',
                'spleen_size': '脾脏大小',
                'kidney_size': '肾脏大小',
                
                // 系统回顾
                'respiratory_symptoms': '呼吸系统症状',
                'cardiovascular_symptoms': '循环系统症状',
                'digestive_symptoms': '消化系统症状',
                'urogenital_symptoms': '泌尿生殖系统症状',
                'nervous_symptoms': '神经系统症状',
                'endocrine_symptoms': '内分泌系统症状',
                'hematologic_symptoms': '血液系统症状',
                'musculoskeletal_symptoms': '肌肉骨骼系统症状',
                
                // 辅助检查
                'blood_test_done': '血液检查',
                'urine_test_done': '尿液检查',
                'stool_test_done': '大便检查',
                'imaging_done': '影像学检查',
                'ecg_done': '心电图检查',
                'endoscopy_done': '内镜检查',
                'pathology_done': '病理检查',
                'blood_test_result': '血液检查结果',
                'urine_test_result': '尿液检查结果',
                'stool_test_result': '大便检查结果',
                'imaging_result': '影像学检查结果',
                'ecg_result': '心电图检查结果',
                'endoscopy_result': '内镜检查结果',
                'pathology_result': '病理检查结果',
                
                // 辅助检查结果详细
                '血常规结果': '血常规结果',
                '尿常规结果': '尿常规结果',
                '肝功能结果': '肝功能结果',
                '肾功能结果': '肾功能结果',
                'X线检查结果': 'X线检查结果',
                'CT检查结果': 'CT检查结果',
                'MRI检查结果': 'MRI检查结果',
                '超声检查结果': '超声检查结果',
                '心电图检查结果': '心电图检查结果',
                
                // 系统回顾详细症状描述
                '体温、发热持续时间、热型等': '发热详情',
                '乏力程度、持续时间、诱因等': '乏力详情',
                '盗汗程度、频率、持续时间等': '盗汗详情',
                '变化幅度和时间': '体重变化详情',
                '咳嗽性质、频率、诱因等': '咳嗽详情',
                '痰量、性状、颜色等': '咳痰详情',
                '咯血量、颜色、频率等': '咯血详情',
                '胸痛部位、性质、诱因等': '胸痛详情',
                '呼吸困难程度、诱因、缓解方式等': '呼吸困难详情',
                '心悸诱因、频率、持续时间等': '心悸详情',
                '胸闷诱因、程度、缓解方式等': '胸闷详情',
                '水肿部位、程度、时间等': '水肿详情',
                '紫绀部位、程度、诱因等': '紫绀详情',
                '食欲变化程度、持续时间等': '食欲详情',
                '恶心诱因、频率、伴随症状等': '恶心详情',
                '呕吐物性状、频率、诱因等': '呕吐详情',
                '腹痛部位、性质、诱因等': '腹痛详情',
                '大便次数、性状、诱因等': '腹泻详情',
                '便秘持续时间、程度、诱因等': '便秘详情',
                '尿频程度、白天夜间情况等': '尿频详情',
                '尿急程度、诱因、伴随症状等': '尿急详情',
                '尿痛部位、程度、诱因等': '尿痛详情',
                '血尿颜色、程度、诱因等': '血尿详情',
                '夜尿次数、尿量、持续时间等': '夜尿详情',
                '头痛部位、性质、诱因等': '头痛详情',
                '头晕性质、诱因、持续时间等': '头晕详情',
                
                // 动态字段映射
                '药物名称': '药物名称',
                '剂量规格': '剂量规格', 
                '用法用量': '用法用量',
                '用药时间': '用药时间',
                '用药效果': '用药效果',
                
                // 个人史详细
                '出生省市': '出生省市',
                '现居住地址': '现居住地址',
                '在此居住多久': '居住年限',
                '疫区地点': '疫区地点',
                '居住时间': '居住时间',
                '接触情况': '接触情况',
                '地方病类型': '地方病类型',
                '传染病类型': '传染病类型',
                '接触时间': '接触时间',
                '具体职业': '具体职业',
                '从事此职业多久': '工作年限',
                '毒物名称': '毒物名称',
                '防护措施': '防护措施',
                '粉尘类型': '粉尘类型',
                '防护情况': '防护情况',
                '放射源类型': '放射源类型',
                '噪音强度': '噪音强度',
                '听力影响': '听力影响',
                '每天几支': '每日吸烟量',
                '吸烟年限': '吸烟年限',
                '烟草类型(如中华、红塔山等)': '烟草类型',
                '戒烟时间(如已戒)': '戒烟时间',
                '酒类种类': '酒类种类',
                '每日饮酒量': '每日饮酒量',
                '饮酒年限': '饮酒年限',
                '戒酒时间(如已戒)': '戒酒时间',
                '使用剂量': '使用剂量',
                '使用年限': '使用年限',
                '毒品类型': '毒品类型',
                '使用方式': '使用方式',
                '异常情况描述': '异常情况描述',
                '疾病名称': '疾病名称',
                '所学专业': '所学专业',
                
                // 外伤史相关
                '外伤部位': '外伤部位',
                '外伤时间': '外伤时间',
                '外伤原因': '外伤原因',
                '术后恢复情况': '术后恢复情况',
                
                // 输血史相关
                '输血时间': '输血时间',
                '输血原因': '输血原因',
                '输血量': '输血量',
                '不良反应': '不良反应',
                
                // 过敏史相关
                '过敏药物名称': '过敏药物名称',
                '过敏反应': '过敏反应',
                '处理经过': '处理经过',
                '过敏食物': '过敏食物',
                '过敏症状': '过敏症状',
                '过敏原': '过敏原',
                '具体接种情况、缺少的疫苗等': '疫苗接种详情',
                
                // 婚姻史
                '结婚时间': '结婚时间',
                
                // 生育史详细
                '总妊娠次数': '总妊娠次数',
                '次': '次数',
                '人': '人数',
                '流产次数': '流产次数',
                '流产时间(孕周)': '流产时间',
                '流产原因': '流产原因',
                '流产方式': '流产方式',
                '术后恢复': '术后恢复',
                '分娩时间': '分娩时间',
                '孕周': '孕周',
                '产程时间': '产程时间',
                '分娩医院': '分娩医院',
                '出生体重(kg)': '出生体重',
                '新生儿异常情况描述': '新生儿异常情况',
                '哺乳时间': '哺乳时间',
                '无法哺乳原因': '无法哺乳原因',
                '使用时间': '使用时间',
                '效果及副作用': '效果及副作用',
                '不孕时间': '不孕时间',
                '检查情况': '检查情况',
                '技术类型': '技术类型',
                '实施时间': '实施时间',
                '成功次数': '成功次数',
                '实施医院': '实施医院',
                '岁': '年龄',
                '配偶生育异常情况': '配偶生育异常情况',
                
                // 月经史
                '天': '天数',
                
                // 其他可能遗漏的字段
                '汉族': '民族',
                '如1×1cm': '淋巴结大小',
                
                // 体格检查更多字段
                'tenderness_nature': '压痛性质',
                'tenderness_extent': '压痛范围',
                'liver_texture': '肝脏质地',
                'liver_edge': '肝脏边缘',
                'liver_tenderness': '肝脏压痛',
                'spleen_texture': '脾脏质地',
                'spleen_tenderness': '脾脏压痛',
                'kidneys': '肾脏',
                'muscle_strength': '肌力',
                'muscle_strength_location': '肌力检查部位',
                'muscle_strength_grade': '肌力级别',
                'muscle_tone': '肌张力',
                'joint_mobility': '关节活动',
                'joint_location': '关节部位',
                'joint_condition': '关节情况',
                'physiological_reflex': '生理反射',
                'pathological_reflex': '病理反射',
                'meningeal_signs': '脑膜刺激征',
                
                // 其他检查
                '心电图、内镜、病理等其他检查': '其他检查结果'
            };
            
            inputs.forEach(input => {
                if (input.value && input.value.trim() !== '') {
                    let key = '';
                    let chineseName = '';
                    
                    // 优先使用name属性，然后是placeholder
                    if (input.name && input.name.trim() !== '') {
                        key = input.name;
                        chineseName = fieldNames[key];
                    } else if (input.placeholder && input.placeholder.trim() !== '') {
                        key = input.placeholder;
                        chineseName = fieldNames[key];
                    }
                    
                    // 处理动态生成的药物字段
                    if (!chineseName && key) {
                        if (key.match(/^drug\d+_name$/)) {
                            chineseName = '药物名称';
                        } else if (key.match(/^drug\d+_dose$/)) {
                            chineseName = '剂量规格';
                        } else if (key.match(/^drug\d+_usage$/)) {
                            chineseName = '用法用量';
                        } else if (key.match(/^drug\d+_duration$/)) {
                            chineseName = '用药时间';
                        } else if (key.match(/^drug\d+_effect$/)) {
                            chineseName = '用药效果';
                        } else {
                            // 如果没有映射，尝试翻译
                            chineseName = translateFieldName(key);
                        }
                    }
                    
                    // 如果还是没有中文名，使用原key
                    if (!chineseName) {
                        chineseName = key || '未知字段';
                    }
                    
                    // 为动态字段添加序号标识
                    if (key && key.match(/^drug\d+_/)) {
                        const drugNumber = key.match(/^drug(\d+)_/)[1];
                        chineseName = `第${drugNumber}种${chineseName}`;
                    }
                    
                    formData[chineseName] = input.value;
                }
            });
            
            // 简单的字段名翻译函数
            function translateFieldName(fieldName) {
                // 常见英文字段的翻译
                const translations = {
                    'name': '姓名',
                    'age': '年龄',
                    'gender': '性别',
                    'phone': '电话',
                    'address': '地址',
                    'occupation': '职业',
                    'temperature': '体温',
                    'pulse': '脉搏',
                    'weight': '体重',
                    'height': '身高',
                    'blood_pressure': '血压',
                    'respiration': '呼吸',
                    'development': '发育状况',
                    'nutrition': '营养状况',
                    'consciousness': '意识状态',
                    'mental_state': '精神状态',
                    'body_position': '体位',
                    'gait': '步态',
                    'skin_color': '皮肤颜色',
                    'skin_elasticity': '皮肤弹性',
                    'rash': '皮疹',
                    'edema': '水肿',
                    'has_fertility_history': '是否有过生育经历',
                    'delivery_type': '分娩方式',
                    'lymph_nodes': '淋巴结',
                    'head': '头颅',
                    'eyes': '眼部',
                    'ent': '耳鼻喉',
                    'neck': '颈部',
                    'chest_shape': '胸廓',
                    'breath_sounds': '呼吸音',
                    'rales': '啰音',
                    'heart_border': '心界',
                    'heart_rate': '心率',
                    'heart_sounds': '心音',
                    'murmur': '心脏杂音',
                    'abdomen_shape': '腹部外观',
                    'abdomen_palpation': '腹部触诊',
                    'tenderness': '压痛',
                    'liver': '肝脏',
                    'spleen': '脾脏',
                    'marital_status': '婚姻状况',
                    'birth_place': '出生地',
                    'current_address': '现住址',
                    'patient_name': '患者姓名',
                    'patient_gender': '性别',
                    'patient_age': '年龄',
                    'patient_ethnicity': '民族',
                    'patient_occupation': '职业',
                    'patient_workplace': '工作单位',
                    'admission_date': '入院日期',
                    'record_date': '记录日期',
                    'emergency_contact_name': '紧急联系人姓名',
                    'emergency_contact_relation': '与患者关系',
                    'emergency_contact_phone': '联系电话',
                    'history_source': '病史来源',
                    'history_reliability': '可靠程度',
                    'chief_complaint': '主诉'
                };
                
                // 如果找到直接翻译，返回翻译结果
                if (translations[fieldName]) {
                    return translations[fieldName];
                }
                
                // 如果是placeholder中文，直接返回
                if (/^[\u4e00-\u9fa5]/.test(fieldName)) {
                    return fieldName;
                }
                
                // 其他情况返回原字段名
                return fieldName;
            }
            
            // 创建Word文档内容
            let content = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>问诊记录</title>';
            content += '<style>body{font-family:SimSun;line-height:1.6;margin:20px;}h1{text-align:center;margin-bottom:20px;}p{margin:5px 0;}</style>';
            content += '</head><body>';
            content += '<h1>问诊记录</h1>';
            
            // 按模块分组显示
            const sections = {
                '基本信息': ['患者姓名', '性别', '年龄', '民族', '婚姻状况', '出生地', '现住址', '职业', '工作单位', '入院日期', '记录日期'],
                '联系信息': ['紧急联系人姓名', '与患者关系', '联系电话', '病史来源', '可靠程度'],
                '主诉': ['主诉'],
                '现病史': ['起病时间', '诱因', '部位', '性质', '持续时间', '频度', '缓解因素', '加重因素', '演变过程', '伴随症状'],
                '用药史': ['药物名称', '剂量规格', '用法用量', '用药时间', '用药效果', '药物相互作用', '用药依从性'],
                '既往史': ['高血压', '糖尿病', '心脏病', '脑血管病', '肝病', '肾病', '恶性肿瘤', '其他慢性病'],
                '传染病史': ['肝炎', '结核病', '其他传染病'],
                '手术外伤史': ['手术史', '外伤史', '输血史'],
                '过敏史': ['药物过敏', '食物过敏', '其他过敏'],
                '个人史': ['出生地', '现居住地', '居住年限', '职业', '工作年限', '吸烟史', '饮酒史'],
                '生育史': ['是否有过生育经历', '总妊娠次数', '足月产', '早产', '流产', '死胎', '现存子女', '分娩方式'],
                '月经史': ['初潮年龄', '月经周期', '月经持续时间', '月经量', '末次月经', '绝经年龄'],
                '家族史': ['父亲健康状况', '母亲健康状况', '家族遗传病史', '兄弟姐妹健康状况'],
                '生命体征': ['体温', '脉搏', '呼吸', '血压', '身高', '体重'],
                '一般状态': ['发育状况', '营养状况', '意识状态', '精神状态', '体位', '步态'],
                '皮肤黏膜': ['皮肤颜色', '皮肤弹性', '皮疹', '水肿'],
                '淋巴结': ['浅表淋巴结', '淋巴结部位', '淋巴结大小', '淋巴结质地'],
                '头颈部': ['头颅', '眼部', '耳鼻喉', '颈部'],
                '胸部': ['胸廓', '呼吸运动', '呼吸音', '啰音'],
                '心脏': ['心界', '心率', '心音', '心脏杂音'],
                '腹部': ['腹部外观', '腹壁静脉', '腹部触诊', '压痛', '肝脏', '脾脏', '肾脏'],
                '四肢': ['肌力', '肌张力', '关节活动'],
                '神经系统': ['生理反射', '病理反射', '脑膜刺激征'],
                '系统回顾': ['发热', '乏力', '盗汗', '体重变化', '咳嗽', '咳痰', '胸痛', '呼吸困难', '心悸', '胸闷', '食欲', '恶心', '呕吐', '腹痛', '腹泻', '便秘', '尿频', '尿急', '尿痛', '血尿', '头痛', '头晕', '失眠'],
                '辅助检查': ['血常规结果', '尿常规结果', '肝功能结果', '肾功能结果', 'X线检查结果', 'CT检查结果', 'MRI检查结果', '超声检查结果', '其他检查结果']
            };
            
            Object.keys(sections).forEach(sectionName => {
                const fields = sections[sectionName];
                const hasData = fields.some(field => formData[field]);
                
                if (hasData) {
                    content += `<h2>${sectionName}</h2>`;
                    fields.forEach(field => {
                        if (formData[field]) {
                            content += `<p><strong>${field}：</strong>${formData[field]}</p>`;
                        }
                    });
                }
            });
            
            // 添加其他字段
            Object.keys(formData).forEach(key => {
                const isInSections = Object.values(sections).flat().includes(key);
                if (!isInSections) {
                    content += `<p><strong>${key}：</strong>${formData[key]}</p>`;
                }
            });
            
            content += '<p style="margin-top:30px;"><strong>生成时间：</strong>' + new Date().toLocaleString('zh-CN') + '</p>';
            content += '</body></html>';
            
            // 创建下载链接
            const blob = new Blob([content], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '问诊记录_' + new Date().toISOString().slice(0,10) + '.doc';
            a.click();
            URL.revokeObjectURL(url);
            
            // 显示成功消息
            alert('问诊记录已成功导出！');
            
        } catch (error) {
            console.error('导出失败:', error);
            alert('导出失败，请检查表单数据是否完整。错误信息：' + error.message);
        }
        }
        
        // 移动端兼容性增强
        function enhanceMobileCompatibility() {
            // 检测是否为移动设备
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // 为所有section标题添加触摸反馈
                const sectionHeaders = document.querySelectorAll('.section h2');
                sectionHeaders.forEach(header => {
                    // 添加触摸开始事件
                    header.addEventListener('touchstart', function(e) {
                        this.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
                    }, { passive: true });
                    
                    // 添加触摸结束事件
                    header.addEventListener('touchend', function(e) {
                        setTimeout(() => {
                            this.style.backgroundColor = '';
                        }, 150);
                    }, { passive: true });
                    
                    // 添加触摸取消事件
                    header.addEventListener('touchcancel', function(e) {
                        this.style.backgroundColor = '';
                    }, { passive: true });
                });
                
                // 为所有select元素添加touch事件优化
                const selects = document.querySelectorAll('select');
                selects.forEach(select => {
                    select.addEventListener('change', function() {
                        // 确保在移动端选择后立即执行相应的函数
                        if (this.onchange) {
                            this.onchange();
                        }
                    });
                });
                
                // 确保疾病史详情在移动端正确显示
                const diseaseSelects = document.querySelectorAll('select[onchange*="toggleDisplay"]');
                diseaseSelects.forEach(select => {
                    select.addEventListener('change', function() {
                        // 强制重新计算布局
                        setTimeout(() => {
                            const targetId = this.getAttribute('onchange').match(/toggleDisplay\('([^']+)'/);
                            if (targetId && targetId[1]) {
                                const targetElement = document.getElementById(targetId[1]);
                                if (targetElement && !targetElement.classList.contains('hidden')) {
                                    targetElement.style.display = 'block';
                                }
                            }
                        }, 100);
                    });
                });
                
                // 禁用双击缩放（仅在section标题上）
                document.addEventListener('touchstart', function(e) {
                    if (e.target.closest('.section h2')) {
                        if (e.touches.length > 1) {
                            e.preventDefault();
                        }
                    }
                }, { passive: false });
                
                // 防止移动端的300ms延迟
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(e) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }
        }
        
        // 添加表单验证函数
        function validateForm() {
            const requiredFields = [
                { name: 'patient_name', label: '患者姓名' },
                { name: 'patient_age', label: '年龄' },
                { name: 'patient_gender', label: '性别' }
            ];
            
            const missingFields = [];
            
            requiredFields.forEach(field => {
                const element = document.querySelector(`[name="${field.name}"]`);
                if (!element || !element.value || element.value.trim() === '') {
                    missingFields.push(field.label);
                }
            });
            
            if (missingFields.length > 0) {
                alert('请填写以下必填项：\n' + missingFields.join('\n'));
                return false;
            }
            
            // 验证年龄范围
            const ageField = document.querySelector('[name="patient_age"]');
            if (ageField && ageField.value) {
                const age = parseInt(ageField.value);
                if (age < 0 || age > 150) {
                    alert('请输入有效的年龄（0-150岁）');
                    return false;
                }
            }
            
            // 验证电话号码格式
            const phoneField = document.querySelector('[name="emergency_contact_phone"]');
            if (phoneField && phoneField.value) {
                const phonePattern = /^1[3-9]\d{9}$/;
                if (!phonePattern.test(phoneField.value)) {
                    alert('请输入有效的手机号码');
                    return false;
                }
            }
            
            return true;
        }
        
        // 保存表单数据到本地存储
        function saveForm() {
            try {
                if (!validateForm()) {
                    return;
                }
                
                const formData = {};
                const inputs = document.querySelectorAll('input, select, textarea');
                
                inputs.forEach(input => {
                    if (input.value && input.value.trim() !== '') {
                        const key = input.name || input.placeholder || `unnamed_${Math.random()}`;
                        formData[key] = input.value;
                    }
                });
                
                localStorage.setItem('medicalRecord', JSON.stringify(formData));
                alert('表单数据已保存到本地！');
                
            } catch (error) {
                console.error('保存失败:', error);
                alert('保存失败：' + error.message);
            }
        }
        
        // 恢复表单数据
        function restoreForm() {
            try {
                const savedData = localStorage.getItem('medicalRecord');
                if (!savedData) {
                    alert('未找到保存的数据');
                    return;
                }
                
                const formData = JSON.parse(savedData);
                
                Object.keys(formData).forEach(key => {
                    const element = document.querySelector(`[name="${key}"]`) || 
                                  document.querySelector(`[placeholder="${key}"]`);
                    if (element) {
                        element.value = formData[key];
                        
                        // 如果是性别选择，触发性别变化事件
                        if (key === 'patient_gender') {
                            onGenderChange(element);
                        }
                        
                        // 触发change事件以显示相关的动态内容
                        if (element.onchange) {
                            element.onchange();
                        }
                    }
                });
                
                alert('表单数据已恢复！');
                
            } catch (error) {
                console.error('恢复失败:', error);
                alert('恢复失败：' + error.message);
            }
        }
        
        // 清空表单
        function clearForm() {
            if (confirm('确定要清空所有表单数据吗？此操作不可恢复。')) {
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        input.checked = false;
                    } else {
                        input.value = '';
                        if (input.selectedIndex !== undefined) {
                            input.selectedIndex = 0;
                        }
                    }
                });
                
                // 隐藏所有动态显示的内容
                const hiddenElements = document.querySelectorAll('.hidden');
                hiddenElements.forEach(element => {
                    element.style.display = 'none';
                });
                
                // 重置性别相关的显示状态
                const menstrualHistory = document.getElementById('menstrual-history');
                const fertilitySection = Array.from(document.querySelectorAll('.section')).find(section => {
                    const h2 = section.querySelector('h2');
                    return h2 && h2.textContent.trim() === '生育史';
                });
                
                if (menstrualHistory) {
                    menstrualHistory.style.display = 'none';
                    menstrualHistory.classList.add('hidden');
                }
                
                if (fertilitySection) {
                    fertilitySection.style.display = 'none';
                    fertilitySection.classList.add('hidden');
                }
                
                alert('表单已清空！');
            }
        }
        
        // 加载模板
        function loadTemplate() {
            const templates = {
                '常规问诊模板': {
                    'patient_name': '张三',
                    'patient_age': '45',
                    'patient_gender': '男',
                    'patient_ethnicity': '汉族',
                    'marital_status': '已婚',
                    'chief_complaint': '胸痛3天',
                    'temperature': '36.5',
                    'pulse': '80',
                    'respiration': '18',
                    'blood_pressure': '120/80'
                }
            };
            
            const templateName = '常规问诊模板';
            const template = templates[templateName];
            
            if (template) {
                Object.keys(template).forEach(key => {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        element.value = template[key];
                        
                        // 如果是性别选择，触发性别变化事件
                        if (key === 'patient_gender') {
                            onGenderChange(element);
                        }
                        
                        // 触发change事件
                        if (element.onchange) {
                            element.onchange();
                        }
                    }
                });
                
                alert(`已加载${templateName}！`);
            }
        }
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置当前日期
            const recordDateField = document.querySelector('[name="record_date"]');
            if (recordDateField && !recordDateField.value) {
                const today = new Date().toISOString().split('T')[0];
                recordDateField.value = today;
            }
        });
    </script>
</head>
<body>
    <h1>问诊助手</h1>    <!-- 基本信息 -->
    <div class="section">
        <h2>基本信息</h2>
        <div class="section-content">
        <div class="form-row">
            <strong>病人信息：</strong>
            <label>姓名</label><input type="text" name="patient_name">
            <label>性别</label>
            <select onchange="onGenderChange(this)" name="patient_gender">
                <option value="男">男</option>
                <option value="女">女</option>
            </select>
            <label>年龄</label><input type="number" min="0" name="patient_age">
            <label>民族</label><input type="text" placeholder="汉族" name="patient_ethnicity">
            <label>婚姻状况</label>
            <select name="marital_status">
                <option>未婚</option>
                <option>已婚</option>
                <option>离异</option>
                <option>丧偶</option>
            </select>
        </div>
        <div class="form-row">
            <label>出生地</label><input type="text" name="birth_place">
            <label>现住址</label><input type="text" name="current_address">
            <label>职业</label><input type="text" name="patient_occupation">
            <label>工作单位</label><input type="text" name="patient_workplace">
            <label>入院日期</label><input type="date" name="admission_date">
            <label>记录日期</label><input type="date" name="record_date">
        </div>
        <div class="form-row">
            <strong>紧急联系人：</strong>
            <label>姓名</label><input type="text" name="emergency_contact_name">
            <label>关系</label>
            <select name="emergency_contact_relation">
                <option>配偶</option>
                <option>父母</option>
                <option>子女</option>
                <option>兄弟姐妹</option>
                <option>其他亲属</option>
                <option>朋友</option>
                <option>同事</option>
            </select>
            <label>联系电话</label><input type="tel" name="emergency_contact_phone">
        </div>
        <div class="form-row">
            <strong>病史来源：</strong>
            <select name="history_source">
                <option>患者本人</option>
                <option>家属代述</option>
                <option>患者本人+家属补充</option>
                <option>既往病历</option>
                <option>其他</option>
            </select>
            <label>可靠程度</label>
            <select name="history_reliability">
                <option>可靠</option>
                <option>基本可靠</option>
                <option>不够可靠</option>
                <option>不可靠</option>
            </select>
        </div>
        </div>
    </div>

    <!-- 主诉 -->
    <div class="section">
        <h2>主诉</h2>
        <div class="section-content">
        <textarea rows="2" placeholder="请填写主诉（简要描述主要症状和持续时间）" name="chief_complaint"></textarea>
        </div>
    </div>

    <!-- 现病史 -->
    <div class="section">
        <h2>现病史</h2>
        <div class="section-content">
        <div class="form-row">
            <strong>起病情况：</strong>
            <label>起病时间</label><input type="text" placeholder="具体日期/时间">
            <label>起病急缓</label>
            <select>
                <option>急性</option>
                <option>亚急性</option>
                <option>慢性</option>
                <option>慢性急性发作</option>
            </select>
            <label>诱因</label><input type="text" placeholder="明确诱因/无明显诱因">
        </div>
        <div class="form-row">
            <strong>主要症状特点：</strong>
            <label>部位</label><input type="text" placeholder="症状发生部位">
            <label>性质</label><input type="text" placeholder="疼痛性质、咳嗽特点等">
            <label>程度</label>
            <select>
                <option>轻度</option>
                <option>中度</option>
                <option>重度</option>
            </select>
            <label>持续时间</label><input type="text" placeholder="持续时间/间歇性">
            <label>频度</label><input type="text" placeholder="发作频率">
        </div>
        <div class="form-row">
            <strong>缓解和加重因素：</strong>
            <label>缓解因素</label><input type="text" placeholder="休息、药物、体位等">
            <label>加重因素</label><input type="text" placeholder="活动、情绪、饮食等">
        </div>
        <div class="form-row">
            <strong>病情发展演变：</strong>
            <textarea rows="2" placeholder="症状变化过程、新症状出现、病情进展情况"></textarea>
        </div>
        <div class="form-row">
            <strong>伴随症状：</strong>
            <textarea rows="2" placeholder="与主症状同时出现的其他症状"></textarea>
        </div>
        <div class="form-row">
            <strong>诊治经过：</strong>
            <label>就诊医院</label><input type="text" placeholder="就诊医院名称">
            <label>检查项目</label><input type="text" placeholder="已做检查项目">
            <label>诊断结果</label><input type="text" placeholder="医生诊断">
        </div>
        <div class="form-row">
            <strong>用药情况：</strong>
            <label>用药种类数量</label>
            <select onchange="generateDrugInputs(this.value)" id="drug-count-select">
                <option value="0">未用药</option>
                <option value="1">1种药物</option>
                <option value="2">2种药物</option>
                <option value="3">3种药物</option>
                <option value="4">4种药物</option>
                <option value="5">5种药物</option>
            </select>
        </div>
        <div id="drug-inputs-container">
            <!-- 药物输入框将在这里动态生成 -->
        </div>
        <div class="form-row">
            <strong>一般情况：</strong>
            <label>精神状态</label>
            <select>
                <option>良好</option>
                <option>一般</option>
                <option>欠佳</option>
                <option>萎靡</option>
            </select>
            <label>食欲</label>
            <select>
                <option>正常</option>
                <option>减退</option>
                <option>亢进</option>
                <option>无食欲</option>
            </select>
            <label>睡眠</label>
            <select>
                <option>正常</option>
                <option>失眠</option>
                <option>多梦</option>
                <option>嗜睡</option>
            </select>
            <label>大便</label>
            <select>
                <option>正常</option>
                <option>便秘</option>
                <option>腹泻</option>
                <option>不规律</option>
            </select>
            <label>小便</label>
            <select>
                <option>正常</option>
                <option>尿频</option>
                <option>尿急</option>
                <option>尿痛</option>
            </select>
            <label>体重变化</label><input type="text" placeholder="增加/减少多少kg">
        </div>
        </div>
    </div>

    <!-- 既往史 -->
    <div class="section">
        <h2>既往史</h2>
        <div class="section-content">
        <div class="form-row">
            <strong>一般健康状况：</strong>
            <label>既往健康状况</label>
            <select>
                <option>良好</option>
                <option>一般</option>
                <option>较差</option>
            </select>
            <label>体质状况</label>
            <select>
                <option>强壮</option>
                <option>一般</option>
                <option>虚弱</option>
            </select>
        </div>
        <div class="form-row">
            <strong>疾病史：</strong>
            <label>高血压</label>
            <select onchange="toggleDisplay('hypertension-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="hypertension-detail" class="hidden">
                <input type="text" placeholder="确诊时间">
                <input type="text" placeholder="最高血压值">
                <input type="text" placeholder="治疗情况">
                <div style="margin-top: 5px;">
                    <label>用药种类数量</label>
                    <select onchange="generateDiseaseInputs('hypertension', this.value)">
                        <option value="0">未用药</option>
                        <option value="1">1种药物</option>
                        <option value="2">2种药物</option>
                        <option value="3">3种药物</option>
                    </select>
                    <div id="hypertension-drug-container"></div>
                </div>
            </span>
        </div>
        <div class="form-row">
            <label>糖尿病</label>
            <select onchange="toggleDisplay('diabetes-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="diabetes-detail" class="hidden">
                <input type="text" placeholder="确诊时间">
                <input type="text" placeholder="血糖控制情况">
                <input type="text" placeholder="治疗方案">
                <div style="margin-top: 5px;">
                    <label>用药种类数量</label>
                    <select onchange="generateDiseaseInputs('diabetes', this.value)">
                        <option value="0">未用药</option>
                        <option value="1">1种药物</option>
                        <option value="2">2种药物</option>
                        <option value="3">3种药物</option>
                    </select>
                    <div id="diabetes-drug-container"></div>
                </div>
            </span>
        </div>
        <div class="form-row">
            <label>心脏病</label>
            <select onchange="toggleDisplay('heart-disease-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="heart-disease-detail" class="hidden">
                <input type="text" placeholder="具体疾病名称">
                <input type="text" placeholder="确诊时间">
                <input type="text" placeholder="治疗情况">
                <div style="margin-top: 5px;">
                    <label>用药种类数量</label>
                    <select onchange="generateDiseaseInputs('heart', this.value)">
                        <option value="0">未用药</option>
                        <option value="1">1种药物</option>
                        <option value="2">2种药物</option>
                        <option value="3">3种药物</option>
                    </select>
                    <div id="heart-drug-container"></div>
                </div>
            </span>
        </div>
        <div class="form-row">
            <label>脑血管病</label>
            <select onchange="toggleDisplay('stroke-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="stroke-detail" class="hidden">
                <input type="text" placeholder="发病时间">
                <input type="text" placeholder="病变部位">
                <input type="text" placeholder="后遗症">
            </span>
        </div>
        <div class="form-row">
            <label>肝病</label>
            <select onchange="toggleDisplay('liver-disease-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="liver-disease-detail" class="hidden">
                <input type="text" placeholder="具体病名">
                <input type="text" placeholder="确诊时间">
                <input type="text" placeholder="治疗经过">
                <div style="margin-top: 5px;">
                    <input type="text" placeholder="用药名称(如护肝药、抗病毒药等)">
                    <input type="text" placeholder="用药剂量">
                    <input type="text" placeholder="肝功能改善情况">
                </div>
            </span>
        </div>
        <div class="form-row">
            <label>肾病</label>
            <select onchange="toggleDisplay('kidney-disease-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="kidney-disease-detail" class="hidden">
                <input type="text" placeholder="具体病名">
                <input type="text" placeholder="确诊时间">
                <input type="text" placeholder="肾功能情况">
                <div style="margin-top: 5px;">
                    <input type="text" placeholder="用药名称(如ACEI/ARB、利尿剂等)">
                    <input type="text" placeholder="用药剂量">
                    <input type="text" placeholder="肾功能保护效果">
                </div>
            </span>
        </div>
        <div class="form-row">
            <label>恶性肿瘤</label>
            <select onchange="toggleDisplay('cancer-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="cancer-detail" class="hidden">
                <input type="text" placeholder="肿瘤类型">
                <input type="text" placeholder="确诊时间">
                <input type="text" placeholder="治疗经过">
                <div style="margin-top: 5px;">
                    <input type="text" placeholder="化疗/靶向药物名称">
                    <input type="text" placeholder="治疗方案">
                    <input type="text" placeholder="治疗效果">
                </div>
            </span>
        </div>
        <div class="form-row">
            <label>其他慢性病</label>
            <select onchange="toggleDisplay('other-chronic-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="other-chronic-detail" class="hidden">
                <textarea rows="2" placeholder="其他慢性疾病详情"></textarea>
            </span>
        </div>
        <div class="form-row">
            <strong>传染病史：</strong>
            <label>肝炎</label>
            <select onchange="toggleDisplay('hepatitis-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="hepatitis-detail" class="hidden">
                <input type="text" placeholder="肝炎类型">
                <input type="text" placeholder="患病时间">
                <input type="text" placeholder="治疗情况">
                <div style="margin-top: 5px;">
                    <input type="text" placeholder="抗病毒药物名称">
                    <input type="text" placeholder="用药方案">
                    <input type="text" placeholder="病毒载量/转氨酶变化">
                </div>
            </span>
        </div>
        <div class="form-row">
            <label>结核病</label>
            <select onchange="toggleDisplay('tuberculosis-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="tuberculosis-detail" class="hidden">
                <input type="text" placeholder="结核部位">
                <input type="text" placeholder="患病时间">
                <input type="text" placeholder="治疗情况">
                <div style="margin-top: 5px;">
                    <input type="text" placeholder="抗结核药物名称">
                    <input type="text" placeholder="治疗方案">
                    <input type="text" placeholder="治疗效果">
                </div>
            </span>
        </div>
        <div class="form-row">
            <label>其他传染病</label>
            <select onchange="toggleDisplay('other-infection-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="other-infection-detail" class="hidden">
                <input type="text" placeholder="具体病名">
                <input type="text" placeholder="患病时间">
            </span>
        </div>
        <div class="form-row">
            <strong>手术外伤史：</strong>
            <label>手术史</label>
            <select onchange="toggleDisplay('surgery-history-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="surgery-history-detail" class="hidden">
                <input type="text" placeholder="手术名称">
                <input type="text" placeholder="手术时间">
                <input type="text" placeholder="手术医院">
                <input type="text" placeholder="麻醉方式">
                <input type="text" placeholder="术后恢复情况">
            </span>
        </div>
        <div class="form-row">
            <label>外伤史</label>
            <select onchange="toggleDisplay('trauma-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="trauma-detail" class="hidden">
                <input type="text" placeholder="外伤部位">
                <input type="text" placeholder="外伤时间">
                <input type="text" placeholder="外伤原因">
                <input type="text" placeholder="治疗情况">
            </span>
        </div>
        <div class="form-row">
            <label>输血史</label>
            <select onchange="toggleDisplay('transfusion-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="transfusion-detail" class="hidden">
                <input type="text" placeholder="输血时间">
                <input type="text" placeholder="输血原因">
                <input type="text" placeholder="输血量">
                <input type="text" placeholder="不良反应">
            </span>
        </div>
        <div class="form-row">
            <strong>过敏史：</strong>
            <label>药物过敏</label>
            <select onchange="toggleDisplay('drug-allergy-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="drug-allergy-detail" class="hidden">
                <input type="text" placeholder="过敏药物名称">
                <input type="text" placeholder="过敏反应">
                <input type="text" placeholder="处理经过">
            </span>
        </div>
        <div class="form-row">
            <label>食物过敏</label>
            <select onchange="toggleDisplay('food-allergy-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="food-allergy-detail" class="hidden">
                <input type="text" placeholder="过敏食物">
                <input type="text" placeholder="过敏症状">
            </span>
        </div>
        <div class="form-row">
            <label>其他过敏</label>
            <select onchange="toggleDisplay('other-allergy-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="other-allergy-detail" class="hidden">
                <input type="text" placeholder="过敏原">
                <input type="text" placeholder="过敏症状">
            </span>
        </div>
        <div class="form-row">
            <strong>预防接种史：</strong>
            <label>疫苗接种</label>
            <select onchange="toggleDisplay('vaccination-detail', this.value)">
                <option>按时接种</option>
                <option>延迟接种</option>
                <option>未完全接种</option>
                <option>不详</option>
            </select>
            <span id="vaccination-detail" class="hidden">
                <textarea rows="2" placeholder="具体接种情况、缺少的疫苗等"></textarea>
            </span>
        </div>
        </div>
    </div>

    <!-- 个人史 -->
    <div class="section">
        <h2>个人史</h2>
        <div class="section-content">
        <div class="form-row">
            <strong>出生及居住史：</strong>
            <label>出生地</label><input type="text" placeholder="出生省市">
            <label>现居住地</label><input type="text" placeholder="现居住地址">
            <label>居住年限</label><input type="text" placeholder="在此居住多久">
        </div>
        <div class="form-row">
            <strong>疫区居住史：</strong>
            <label>血吸虫病疫区</label>
            <select onchange="toggleDisplay('schistosomiasis-area', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="schistosomiasis-area" class="hidden">
                <input type="text" placeholder="疫区地点">
                <input type="text" placeholder="居住时间">
                <input type="text" placeholder="接触情况">
            </span>
        </div>
        <div class="form-row">
            <label>地方病疫区</label>
            <select onchange="toggleDisplay('endemic-area', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="endemic-area" class="hidden">
                <input type="text" placeholder="地方病类型">
                <input type="text" placeholder="疫区地点">
                <input type="text" placeholder="居住时间">
            </span>
        </div>
        <div class="form-row">
            <label>传染病疫区</label>
            <select onchange="toggleDisplay('epidemic-area', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="epidemic-area" class="hidden">
                <input type="text" placeholder="传染病类型">
                <input type="text" placeholder="疫区地点">
                <input type="text" placeholder="接触时间">
            </span>
        </div>
        <div class="form-row">
            <strong>职业史：</strong>
            <label>职业</label><input type="text" placeholder="具体职业">
            <label>工作年限</label><input type="text" placeholder="从事此职业多久">
            <label>工作环境</label>
            <select>
                <option>良好</option>
                <option>一般</option>
                <option>较差</option>
                <option>恶劣</option>
            </select>
        </div>
        <div class="form-row">
            <strong>职业危害接触史：</strong>
            <label>有毒物质</label>
            <select onchange="toggleDisplay('toxic-exposure', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="toxic-exposure" class="hidden">
                <input type="text" placeholder="毒物名称">
                <input type="text" placeholder="接触时间">
                <input type="text" placeholder="防护措施">
            </span>
        </div>
        <div class="form-row">
            <label>粉尘接触</label>
            <select onchange="toggleDisplay('dust-exposure', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="dust-exposure" class="hidden">
                <input type="text" placeholder="粉尘类型">
                <input type="text" placeholder="接触时间">
                <input type="text" placeholder="防护情况">
            </span>
        </div>
        <div class="form-row">
            <label>放射性物质</label>
            <select onchange="toggleDisplay('radiation-exposure', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="radiation-exposure" class="hidden">
                <input type="text" placeholder="放射源类型">
                <input type="text" placeholder="接触时间">
                <input type="text" placeholder="防护措施">
            </span>
        </div>
        <div class="form-row">
            <label>噪音接触</label>
            <select onchange="toggleDisplay('noise-exposure', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="noise-exposure" class="hidden">
                <input type="text" placeholder="噪音强度">
                <input type="text" placeholder="接触时间">
                <input type="text" placeholder="听力影响">
            </span>
        </div>
        <div class="form-row">
            <strong>生活习惯：</strong>
            <label>吸烟史</label>
            <select onchange="toggleDisplay('smoking-detail', this.value)">
                <option>从不吸烟</option>
                <option>已戒烟</option>
                <option>吸烟</option>
            </select>
            <span id="smoking-detail" class="hidden">
                <input type="number" placeholder="每天几支" min="0" max="100">
                <input type="text" placeholder="吸烟年限">
                <input type="text" placeholder="烟草类型(如中华、红塔山等)">
                <input type="text" placeholder="戒烟时间(如已戒)">
            </span>
        </div>
        <div class="form-row">
            <label>饮酒史</label>
            <select onchange="toggleDisplay('drinking-detail', this.value)">
                <option>从不饮酒</option>
                <option>已戒酒</option>
                <option>偶尔饮酒</option>
                <option>经常饮酒</option>
            </select>
            <span id="drinking-detail" class="hidden">
                <input type="text" placeholder="酒类种类">
                <input type="text" placeholder="每日饮酒量">
                <input type="text" placeholder="饮酒年限">
                <input type="text" placeholder="戒酒时间(如已戒)">
            </span>
        </div>
        <div class="form-row">
            <label>药物依赖</label>
            <select onchange="toggleDisplay('drug-dependence', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="drug-dependence" class="hidden">
                <input type="text" placeholder="药物名称">
                <input type="text" placeholder="使用剂量">
                <input type="text" placeholder="使用年限">
            </span>
        </div>
        <div class="form-row">
            <label>毒品使用</label>
            <select onchange="toggleDisplay('drug-abuse', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="drug-abuse" class="hidden">
                <input type="text" placeholder="毒品类型">
                <input type="text" placeholder="使用方式">
                <input type="text" placeholder="使用年限">
            </span>
        </div>
        <div class="form-row">
            <strong>性生活史：</strong>
            <label>性生活史</label>
            <select onchange="toggleDisplay('sexual-history', this.value)">
                <option>正常</option>
                <option>异常</option>
                <option>拒绝回答</option>
            </select>
            <span id="sexual-history" class="hidden">
                <input type="text" placeholder="异常情况描述">
            </span>
        </div>
        <div class="form-row">
            <label>性传播疾病史</label>
            <select onchange="toggleDisplay('std-history', this.value)">
                <option>无</option>
                <option>有</option>
                <option>不详</option>
            </select>
            <span id="std-history" class="hidden">
                <input type="text" placeholder="疾病名称">
                <input type="text" placeholder="患病时间">
                <input type="text" placeholder="治疗情况">
            </span>
        </div>
        <div class="form-row">
            <strong>教育背景：</strong>
            <label>文化程度</label>
            <select>
                <option>小学</option>
                <option>初中</option>
                <option>高中/中专</option>
                <option>大专</option>
                <option>本科</option>
                <option>研究生及以上</option>
                <option>文盲</option>
            </select>
            <label>专业</label><input type="text" placeholder="所学专业">
        </div>
        </div>
    </div>

    <!-- 婚姻史 -->
    <div class="section">
        <h2>婚姻史</h2>
        <div class="section-content">
        <div class="form-row">
            是否结婚
            <select onchange="toggleDisplay('married-info', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="married-info" class="hidden">
                结婚时间 <input type="text" placeholder="结婚时间">
                配偶健在
                <select>
                    <option>有</option>
                    <option>无</option>
                </select>
                有无子女
                <select onchange="toggleDisplay('children-info', this.value)">
                    <option>无</option>
                    <option>有</option>
                </select>
                <span id="children-info" class="hidden">
                    子女人数 <input type="number" min="0">
                </span>
            </span>
        </div>
        </div>
    </div>

    <!-- 生育史 -->
    <div class="section">
        <h2>生育史</h2>
        <div class="section-content">
        <div class="form-row">
            <strong>是否有过生育经历：</strong>
            <select onchange="toggleDisplay('fertility-history', this.value, '有')" name="has_fertility_history">
                <option>无</option>
                <option>有</option>
            </select>
        </div>
        <div id="fertility-history" class="hidden">
            <div class="form-row">
                <strong>妊娠史：</strong>
                <label>妊娠次数</label><input type="number" min="0" placeholder="总妊娠次数">
                <label>足月产</label><input type="number" min="0" placeholder="次">
                <label>早产</label><input type="number" min="0" placeholder="次">
                <label>流产</label><input type="number" min="0" placeholder="次">
                <label>死胎</label><input type="number" min="0" placeholder="次">
                <label>现存子女</label><input type="number" min="0" placeholder="人">
            </div>
            <div class="form-row">
                <strong>流产史详情：</strong>
                <label>自然流产</label>
                <select onchange="toggleDisplay('spontaneous-abortion', this.value)">
                    <option>无</option>
                    <option>有</option>
                </select>
                <span id="spontaneous-abortion" class="hidden">
                    <input type="text" placeholder="流产次数">
                    <input type="text" placeholder="流产时间(孕周)">
                    <input type="text" placeholder="流产原因">
                </span>
            </div>
            <div class="form-row">
                <label>人工流产</label>
                <select onchange="toggleDisplay('induced-abortion', this.value)">
                    <option>无</option>
                    <option>有</option>
                </select>
                <span id="induced-abortion" class="hidden">
                    <input type="text" placeholder="流产次数">
                    <input type="text" placeholder="流产方式">
                    <input type="text" placeholder="流产原因">
                    <input type="text" placeholder="术后恢复">
                </span>
            </div>
            <div class="form-row">
                <strong>分娩史：</strong>
                <label>分娩方式</label>
                <select onchange="toggleDisplay('delivery-detail', this.value, '自然分娩')" name="delivery_type">
                    <option>无分娩史</option>
                    <option>自然分娩</option>
                    <option>剖宫产</option>
                    <option>助产分娩</option>
                </select>
                <span id="delivery-detail" class="hidden">
                    <input type="text" placeholder="分娩时间">
                    <input type="text" placeholder="孕周">
                    <input type="text" placeholder="产程时间">
                    <input type="text" placeholder="分娩医院">
                </span>
            </div>
            <div class="form-row">
                <strong>新生儿情况：</strong>
                <label>新生儿体重</label><input type="text" placeholder="出生体重(kg)">
                <label>新生儿健康状况</label>
                <select onchange="toggleDisplay('newborn-health', this.value, '异常')">
                    <option>健康</option>
                    <option>异常</option>
                </select>
                <span id="newborn-health" class="hidden">
                    <textarea rows="2" placeholder="新生儿异常情况描述"></textarea>
                </span>
            </div>
            <div class="form-row">
                <strong>产后情况：</strong>
                <label>产褥期</label>
                <select>
                    <option>正常</option>
                    <option>发热</option>
                    <option>感染</option>
                    <option>其他异常</option>
                </select>
                <label>哺乳情况</label>
                <select onchange="toggleDisplay('breastfeeding', this.value, '无法哺乳')">
                    <option>纯母乳喂养</option>
                    <option>混合喂养</option>
                    <option>人工喂养</option>
                    <option>无法哺乳</option>
                </select>
                <span id="breastfeeding" class="hidden">
                    <input type="text" placeholder="哺乳时间">
                    <input type="text" placeholder="无法哺乳原因">
                </span>
            </div>
            <div class="form-row">
                <strong>避孕史：</strong>
                <label>避孕方法</label>
                <select onchange="toggleDisplay('contraception', this.value, '无避孕')">
                    <option>无避孕</option>
                    <option>安全期避孕</option>
                    <option>避孕套</option>
                    <option>口服避孕药</option>
                    <option>宫内节育器</option>
                    <option>结扎</option>
                    <option>其他</option>
                </select>
                <span id="contraception" class="hidden">
                    <input type="text" placeholder="使用时间">
                    <input type="text" placeholder="效果及副作用">
                </span>
            </div>
            <div class="form-row">
                <strong>不孕不育史：</strong>
                <label>不孕症</label>
                <select onchange="toggleDisplay('infertility', this.value, '原发性不孕')">
                    <option>无</option>
                    <option>原发性不孕</option>
                    <option>继发性不孕</option>
                </select>
                <span id="infertility" class="hidden">
                    <input type="text" placeholder="不孕时间">
                    <input type="text" placeholder="检查情况">
                    <input type="text" placeholder="治疗经过">
                </span>
            </div>
            <div class="form-row">
                <strong>辅助生殖史：</strong>
                <label>辅助生殖技术</label>
                <select onchange="toggleDisplay('assisted-reproduction', this.value, '人工授精')">
                    <option>无</option>
                    <option>人工授精</option>
                    <option>试管婴儿</option>
                    <option>其他</option>
                </select>
                <span id="assisted-reproduction" class="hidden">
                    <input type="text" placeholder="技术类型">
                    <input type="text" placeholder="实施时间">
                    <input type="text" placeholder="成功次数">
                    <input type="text" placeholder="实施医院">
                </span>
            </div>
            <div class="form-row">
                <strong>配偶情况：</strong>
                <label>配偶年龄</label><input type="number" min="0" placeholder="岁">
                <label>配偶健康状况</label>
                <select>
                    <option>健康</option>
                    <option>一般</option>
                    <option>有疾病</option>
                </select>
                <label>配偶生育史</label>
                <select onchange="toggleDisplay('spouse-fertility', this.value, '异常')">
                    <option>正常</option>
                    <option>异常</option>
                </select>
                <span id="spouse-fertility" class="hidden">
                    <textarea rows="2" placeholder="配偶生育异常情况"></textarea>
                </span>
            </div>
        </div>
        </div>
    </div>

    <!-- 月经史（仅女性显示） -->
    <div class="section hidden" id="menstrual-history">
        <h2>月经史</h2>
        <div class="section-content">
        <div class="form-row">
            <label>初潮年龄</label><input type="number" min="0" placeholder="岁">
            <label>周期</label><input type="text" placeholder="天">
            <label>经期</label><input type="text" placeholder="天">
            <label>量</label>
            <select>
                <option>正常</option>
                <option>过多</option>
                <option>过少</option>
            </select>
            <label>痛经</label>
            <select>
                <option>无</option>
                <option>轻度</option>
                <option>中度</option>
                <option>重度</option>
            </select>
        </div>
        <div class="form-row">
            <label>末次月经</label><input type="date">
            <label>绝经</label>
            <select onchange="toggleDisplay('menopause-info', this.value)">
                <option>否</option>
                <option>是</option>
            </select>
            <span id="menopause-info" class="hidden">
                <label>绝经年龄</label><input type="number" min="0" placeholder="岁">
            </span>
        </div>
        </div>
    </div>

    <!-- 家族史 -->
    <div class="section">
        <h2>家族史</h2>
        <div class="section-content">
        <div class="form-row">
            父亲健康状况
            <select onchange="toggleDisplay('father-health', this.value)">
                <option>健在</option>
                <option>已故</option>
                <option>不详</option>
            </select>
            <span id="father-health" class="hidden">
                <input type="text" placeholder="死因/疾病史">
                <label>享年</label><input type="number" min="0" placeholder="岁">
            </span>
        </div>
        <div class="form-row">
            母亲健康状况
            <select onchange="toggleDisplay('mother-health', this.value)">
                <option>健在</option>
                <option>已故</option>
                <option>不详</option>
            </select>
            <span id="mother-health" class="hidden">
                <input type="text" placeholder="死因/疾病史">
                <label>享年</label><input type="number" min="0" placeholder="岁">
            </span>
        </div>
        <div class="form-row">
            家族遗传病史
            <select onchange="toggleDisplay('family-disease', this.value)">
                <option>无</option>
                <option>有</option>
                <option>不详</option>
            </select>
            <span id="family-disease" class="hidden">
                <input type="text" placeholder="请详细描述遗传病史">
            </span>
        </div>
        <div class="form-row">
            兄弟姐妹健康状况
            <select onchange="toggleDisplay('siblings-health', this.value)">
                <option>无兄弟姐妹</option>
                <option>均健康</option>
                <option>有疾病</option>
                <option>不详</option>
            </select>
            <span id="siblings-health" class="hidden">
                <input type="text" placeholder="请描述疾病情况">
            </span>
        </div>
        </div>
    </div>

    <!-- 系统回顾 -->
    <div class="section">
        <h2>系统回顾</h2>
        <div class="section-content">
        <div class="form-row">
            <strong>一般状况：</strong>
            <label>发热</label>
            <select onchange="toggleDisplay('fever-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="fever-detail" class="hidden">
                <input type="text" placeholder="体温、发热持续时间、热型等">
            </span>
            <label>乏力</label>
            <select onchange="toggleDisplay('fatigue-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="fatigue-detail" class="hidden">
                <input type="text" placeholder="乏力程度、持续时间、诱因等">
            </span>
            <label>盗汗</label>
            <select onchange="toggleDisplay('sweats-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="sweats-detail" class="hidden">
                <input type="text" placeholder="盗汗程度、频率、持续时间等">
            </span>
            <label>体重变化</label>
            <select onchange="toggleDisplay('weight-change', this.value, '增加')">
                <option>无</option>
                <option>增加</option>
                <option>减少</option>
            </select>
            <span id="weight-change" class="hidden">
                <input type="text" placeholder="变化幅度和时间">
            </span>
        </div>
        <div class="form-row">
            <strong>呼吸系统：</strong>
            <label>咳嗽</label>
            <select onchange="toggleDisplay('cough-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="cough-detail" class="hidden">
                <input type="text" placeholder="咳嗽性质、频率、诱因等">
            </span>
            <label>咳痰</label>
            <select onchange="toggleDisplay('sputum-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="sputum-detail" class="hidden">
                <input type="text" placeholder="痰量、性状、颜色等">
            </span>
            <label>咯血</label>
            <select onchange="toggleDisplay('hemoptysis-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="hemoptysis-detail" class="hidden">
                <input type="text" placeholder="咯血量、颜色、频率等">
            </span>
            <label>胸痛</label>
            <select onchange="toggleDisplay('chest-pain-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="chest-pain-detail" class="hidden">
                <input type="text" placeholder="胸痛部位、性质、诱因等">
            </span>
            <label>呼吸困难</label>
            <select onchange="toggleDisplay('dyspnea-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="dyspnea-detail" class="hidden">
                <input type="text" placeholder="呼吸困难程度、诱因、缓解方式等">
            </span>
        </div>
        <div class="form-row">
            <strong>循环系统：</strong>
            <label>心悸</label>
            <select onchange="toggleDisplay('palpitation-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="palpitation-detail" class="hidden">
                <input type="text" placeholder="心悸诱因、频率、持续时间等">
            </span>
            <label>胸闷</label>
            <select onchange="toggleDisplay('chest-tightness-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="chest-tightness-detail" class="hidden">
                <input type="text" placeholder="胸闷诱因、程度、缓解方式等">
            </span>
            <label>水肿</label>
            <select onchange="toggleDisplay('edema-system-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="edema-system-detail" class="hidden">
                <input type="text" placeholder="水肿部位、程度、时间等">
            </span>
            <label>紫绀</label>
            <select onchange="toggleDisplay('cyanosis-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="cyanosis-detail" class="hidden">
                <input type="text" placeholder="紫绀部位、程度、诱因等">
            </span>
        </div>
        <div class="form-row">
            <strong>消化系统：</strong>
            <label>食欲</label>
            <select onchange="toggleDisplay('appetite-detail', this.value, '减退')">
                <option>正常</option>
                <option>减退</option>
                <option>亢进</option>
            </select>
            <span id="appetite-detail" class="hidden">
                <input type="text" placeholder="食欲变化程度、持续时间等">
            </span>
            <label>恶心</label>
            <select onchange="toggleDisplay('nausea-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="nausea-detail" class="hidden">
                <input type="text" placeholder="恶心诱因、频率、伴随症状等">
            </span>
            <label>呕吐</label>
            <select onchange="toggleDisplay('vomiting-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="vomiting-detail" class="hidden">
                <input type="text" placeholder="呕吐物性状、频率、诱因等">
            </span>
            <label>腹痛</label>
            <select onchange="toggleDisplay('abdominal-pain-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="abdominal-pain-detail" class="hidden">
                <input type="text" placeholder="腹痛部位、性质、诱因等">
            </span>
            <label>腹泻</label>
            <select onchange="toggleDisplay('diarrhea-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="diarrhea-detail" class="hidden">
                <input type="text" placeholder="大便次数、性状、诱因等">
            </span>
            <label>便秘</label>
            <select onchange="toggleDisplay('constipation-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="constipation-detail" class="hidden">
                <input type="text" placeholder="便秘持续时间、程度、诱因等">
            </span>
        </div>
        <div class="form-row">
            <strong>泌尿生殖系统：</strong>
            <label>尿频</label>
            <select onchange="toggleDisplay('urinary-frequency-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="urinary-frequency-detail" class="hidden">
                <input type="text" placeholder="尿频程度、白天夜间情况等">
            </span>
            <label>尿急</label>
            <select onchange="toggleDisplay('urinary-urgency-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="urinary-urgency-detail" class="hidden">
                <input type="text" placeholder="尿急程度、诱因、伴随症状等">
            </span>
            <label>尿痛</label>
            <select onchange="toggleDisplay('dysuria-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="dysuria-detail" class="hidden">
                <input type="text" placeholder="尿痛部位、程度、诱因等">
            </span>
            <label>血尿</label>
            <select onchange="toggleDisplay('hematuria-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="hematuria-detail" class="hidden">
                <input type="text" placeholder="血尿颜色、程度、诱因等">
            </span>
            <label>夜尿增多</label>
            <select onchange="toggleDisplay('nocturia-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="nocturia-detail" class="hidden">
                <input type="text" placeholder="夜尿次数、尿量、持续时间等">
            </span>
        </div>
        <div class="form-row">
            <strong>神经系统：</strong>
            <label>头痛</label>
            <select onchange="toggleDisplay('headache-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="headache-detail" class="hidden">
                <input type="text" placeholder="头痛部位、性质、诱因等">
            </span>
            <label>头晕</label>
            <select onchange="toggleDisplay('dizziness-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="dizziness-detail" class="hidden">
                <input type="text" placeholder="头晕性质、诱因、持续时间等">
            </span>
            <label>失眠</label>
            <select onchange="toggleDisplay('insomnia-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="insomnia-detail" class="hidden">
                <input type="text" placeholder="失眠类型、程度、诱因等">
            </span>
            <label>记忆力减退</label>
            <select onchange="toggleDisplay('memory-loss-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="memory-loss-detail" class="hidden">
                <input type="text" placeholder="记忆减退程度、持续时间等">
            </span>
            <label>肢体麻木</label>
            <select onchange="toggleDisplay('numbness-detail', this.value)">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="numbness-detail" class="hidden">
                <input type="text" placeholder="麻木部位、程度、诱因等">
            </span>
        </div>
        </div>
    </div>

    <!-- 体格检查 -->
    <div class="section">
        <h2>体格检查</h2>
        <div class="section-content">
        <div class="form-row">
            <strong>生命体征：</strong>
            <label>体温</label><input type="text" placeholder="°C" name="temperature">
            <label>脉搏</label><input type="text" placeholder="次/分" name="pulse">
            <label>呼吸</label><input type="text" placeholder="次/分" name="respiration">
            <label>血压</label><input type="text" placeholder="mmHg" name="blood_pressure">
            <label>身高</label><input type="text" placeholder="cm" name="height">
            <label>体重</label><input type="text" placeholder="kg" name="weight">
        </div>
        <div class="form-row">
            <strong>一般状态：</strong>
            <label>发育状况</label>
            <select name="development">
                <option>正常</option>
                <option>发育不良</option>
                <option>发育迟缓</option>
            </select>
            <label>营养状况</label>
            <select name="nutrition">
                <option>良好</option>
                <option>中等</option>
                <option>不良</option>
                <option>消瘦</option>
                <option>肥胖</option>
            </select>
            <label>意识状态</label>
            <select name="consciousness">
                <option>清醒</option>
                <option>嗜睡</option>
                <option>昏睡</option>
                <option>昏迷</option>
                <option>谵妄</option>
            </select>
            <label>精神状态</label>
            <select name="mental_state">
                <option>合作</option>
                <option>紧张</option>
                <option>烦躁</option>
                <option>抑郁</option>
                <option>淡漠</option>
            </select>
        </div>
        <div class="form-row">
            <strong>体位步态：</strong>
            <label>体位</label>
            <select name="body_position">
                <option>自主体位</option>
                <option>被动体位</option>
                <option>强迫体位</option>
                <option>端坐位</option>
                <option>侧卧位</option>
            </select>
            <label>步态</label>
            <select name="gait">
                <option>正常</option>
                <option>跛行</option>
                <option>剪刀步态</option>
                <option>醉酒步态</option>
                <option>帕金森步态</option>
                <option>无法行走</option>
            </select>
        </div>
        <div class="form-row">
            <strong>皮肤黏膜：</strong>
            <label>皮肤颜色</label>
            <select name="skin_color">
                <option>正常</option>
                <option>苍白</option>
                <option>发绀</option>
                <option>黄染</option>
                <option>潮红</option>
                <option>色素沉着</option>
            </select>
            <label>皮肤弹性</label>
            <select name="skin_elasticity">
                <option>正常</option>
                <option>弹性差</option>
                <option>弹性消失</option>
            </select>
            <label>皮疹</label>
            <select onchange="toggleDisplay('rash-detail', this.value)" name="rash">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="rash-detail" class="hidden">
                <label>类型</label>
                <select name="rash_type">
                    <option>丘疹</option>
                    <option>斑疹</option>
                    <option>丘疱疹</option>
                    <option>水疱</option>
                    <option>脓疱</option>
                    <option>结节</option>
                    <option>荨麻疹</option>
                    <option>紫癜</option>
                    <option>瘀斑</option>
                    <option>其他</option>
                </select>
                <label>分布</label>
                <select name="rash_distribution">
                    <option>全身性</option>
                    <option>局限性</option>
                    <option>对称性</option>
                    <option>单侧性</option>
                    <option>暴露部位</option>
                    <option>屈侧</option>
                    <option>伸侧</option>
                </select>
                <input type="text" placeholder="具体部位描述" name="rash_location">
            </span>
            <label>水肿</label>
            <select onchange="toggleDisplay('edema-detail', this.value)" name="edema">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="edema-detail" class="hidden">
                <label>部位</label>
                <select name="edema_location">
                    <option>双下肢</option>
                    <option>左下肢</option>
                    <option>右下肢</option>
                    <option>双上肢</option>
                    <option>左上肢</option>
                    <option>右上肢</option>
                    <option>颜面部</option>
                    <option>眼睑部</option>
                    <option>全身性</option>
                    <option>腹部</option>
                    <option>腰骶部</option>
                </select>
                <label>程度</label>
                <select name="edema_degree">
                    <option>轻度(+)</option>
                    <option>中度(++)</option>
                    <option>重度(+++)</option>
                    <option>极重度(++++)</option>
                </select>
                <label>性质</label>
                <select name="edema_nature">
                    <option>凹陷性</option>
                    <option>非凹陷性</option>
                    <option>硬性</option>
                </select>
            </span>
        </div>
        <div class="form-row">
            <strong>淋巴结：</strong>
            <label>浅表淋巴结</label>
            <select onchange="toggleDisplay('lymph-detail', this.value)" name="lymph_nodes">
                <option>未触及肿大</option>
                <option>触及肿大</option>
            </select>
            <span id="lymph-detail" class="hidden">
                <label>部位</label>
                <select name="lymph_location">
                    <option>颈部</option>
                    <option>耳后</option>
                    <option>耳前</option>
                    <option>颌下</option>
                    <option>锁骨上</option>
                    <option>腋窝</option>
                    <option>腹股沟</option>
                    <option>滑车上</option>
                    <option>多处</option>
                </select>
                <label>大小</label>
                <input type="text" placeholder="如1×1cm" name="lymph_size">
                <label>质地</label>
                <select name="lymph_texture">
                    <option>质软</option>
                    <option>质韧</option>
                    <option>质硬</option>
                    <option>质脆</option>
                </select>
                <label>活动度</label>
                <select name="lymph_mobility">
                    <option>活动</option>
                    <option>固定</option>
                    <option>与皮肤粘连</option>
                    <option>与深部组织粘连</option>
                </select>
                <label>压痛</label>
                <select name="lymph_tenderness">
                    <option>无压痛</option>
                    <option>有压痛</option>
                </select>
            </span>
        </div>
        <div class="form-row">
            <strong>头颈部：</strong>
            <label>头颅</label>
            <select name="head">
                <option>正常</option>
                <option>小头畸形</option>
                <option>大头畸形</option>
                <option>外伤痕迹</option>
            </select>
            <label>眼部</label>
            <select name="eyes">
                <option>正常</option>
                <option>结膜苍白</option>
                <option>巩膜黄染</option>
                <option>瞳孔异常</option>
                <option>眼睑水肿</option>
            </select>
            <label>耳鼻喉</label>
            <select name="ent">
                <option>正常</option>
                <option>听力减退</option>
                <option>鼻塞</option>
                <option>咽喉充血</option>
                <option>扁桃体肿大</option>
            </select>
            <label>颈部</label>
            <select name="neck">
                <option>正常</option>
                <option>颈静脉怒张</option>
                <option>甲状腺肿大</option>
                <option>颈部僵硬</option>
            </select>
        </div>
        <div class="form-row">
            <strong>胸部检查：</strong>
            <label>胸廓</label>
            <select name="chest_shape">
                <option>正常</option>
                <option>桶状胸</option>
                <option>扁平胸</option>
                <option>鸡胸</option>
                <option>漏斗胸</option>
                <option>不对称</option>
            </select>
            <label>呼吸运动</label>
            <select name="breathing">
                <option>正常</option>
                <option>呼吸浅快</option>
                <option>呼吸深慢</option>
                <option>呼吸不规则</option>
                <option>一侧减弱</option>
            </select>
        </div>
        <div class="form-row">
            <strong>肺部听诊：</strong>
            <label>呼吸音</label>
            <select name="breath_sounds">
                <option>正常</option>
                <option>呼吸音减弱</option>
                <option>呼吸音消失</option>
                <option>支气管呼吸音</option>
                <option>粗糙呼吸音</option>
            </select>
            <label>啰音</label>
            <select name="rales">
                <option>无</option>
                <option>湿啰音</option>
                <option>干啰音</option>
                <option>捻发音</option>
                <option>胸膜摩擦音</option>
            </select>
        </div>
        <div class="form-row">
            <strong>心脏检查：</strong>
            <label>心界</label>
            <select name="heart_border">
                <option>正常</option>
                <option>左心扩大</option>
                <option>右心扩大</option>
                <option>全心扩大</option>
            </select>
            <label>心率</label>
            <select name="heart_rate">
                <option>正常</option>
                <option>心动过速</option>
                <option>心动过缓</option>
                <option>心律不齐</option>
            </select>
            <label>心音</label>
            <select name="heart_sounds">
                <option>正常</option>
                <option>心音减弱</option>
                <option>心音分裂</option>
                <option>奔马律</option>
                <option>额外心音</option>
            </select>
            <label>心脏杂音</label>
            <select name="murmur">
                <option>无</option>
                <option>收缩期杂音</option>
                <option>舒张期杂音</option>
                <option>连续性杂音</option>
            </select>
        </div>
        <div class="form-row">
            <strong>腹部检查：</strong>
            <label>腹部外观</label>
            <select name="abdomen_shape">
                <option>平坦</option>
                <option>膨隆</option>
                <option>凹陷</option>
                <option>不对称</option>
            </select>
            <label>腹壁静脉</label>
            <select name="abdominal_veins">
                <option>不显露</option>
                <option>轻度怒张</option>
                <option>明显怒张</option>
                <option>侧支循环</option>
            </select>
            <label>腹部触诊</label>
            <select name="abdomen_palpation">
                <option>软</option>
                <option>轻度紧张</option>
                <option>肌紧张</option>
                <option>板样强直</option>
            </select>
            <label>压痛</label>
            <select onchange="toggleDisplay('tenderness-detail', this.value)" name="tenderness">
                <option>无</option>
                <option>有</option>
            </select>
            <span id="tenderness-detail" class="hidden">
                <label>部位</label>
                <select name="tenderness_location">
                    <option>右上腹</option>
                    <option>左上腹</option>
                    <option>上腹部(剑突下)</option>
                    <option>右肋缘下</option>
                    <option>左肋缘下</option>
                    <option>右腰部</option>
                    <option>左腰部</option>
                    <option>脐周</option>
                    <option>右下腹</option>
                    <option>左下腹</option>
                    <option>耻骨上</option>
                    <option>麦氏点</option>
                    <option>墨菲征阳性点</option>
                    <option>全腹</option>
                </select>
                <label>性质</label>
                <select name="tenderness_nature">
                    <option>轻度压痛</option>
                    <option>明显压痛</option>
                    <option>反跳痛</option>
                    <option>深压痛</option>
                </select>
                <label>范围</label>
                <select name="tenderness_extent">
                    <option>局限性</option>
                    <option>广泛性</option>
                    <option>固定性</option>
                    <option>游走性</option>
                </select>
            </span>
        </div>
        <div class="form-row">
            <strong>腹部脏器：</strong>
            <label>肝脏</label>
            <select onchange="toggleDisplay('liver-detail', this.value)" name="liver">
                <option>未触及</option>
                <option>可触及</option>
            </select>
            <span id="liver-detail" class="hidden">
                <label>大小</label>
                <select name="liver_size">
                    <option>肋下1cm</option>
                    <option>肋下2cm</option>
                    <option>肋下3cm</option>
                    <option>肋下4cm</option>
                    <option>肋下5cm以上</option>
                    <option>剑突下可及</option>
                </select>
                <label>质地</label>
                <select name="liver_texture">
                    <option>质软</option>
                    <option>质韧</option>
                    <option>质硬</option>
                    <option>质脆</option>
                </select>
                <label>边缘</label>
                <select name="liver_edge">
                    <option>光滑</option>
                    <option>不光滑</option>
                    <option>钝</option>
                    <option>锐</option>
                    <option>结节状</option>
                </select>
                <label>压痛</label>
                <select name="liver_tenderness">
                    <option>无压痛</option>
                    <option>有压痛</option>
                </select>
            </span>
            <label>脾脏</label>
            <select onchange="toggleDisplay('spleen-detail', this.value)" name="spleen">
                <option>未触及</option>
                <option>可触及</option>
            </select>
            <span id="spleen-detail" class="hidden">
                <label>大小</label>
                <select name="spleen_size">
                    <option>肋下1cm</option>
                    <option>肋下2cm</option>
                    <option>肋下3cm</option>
                    <option>肋下4cm</option>
                    <option>肋下5cm以上</option>
                    <option>平脐</option>
                    <option>脐下</option>
                </select>
                <label>质地</label>
                <select name="spleen_texture">
                    <option>质软</option>
                    <option>质韧</option>
                    <option>质硬</option>
                </select>
                <label>压痛</label>
                <select name="spleen_tenderness">
                    <option>无压痛</option>
                    <option>有压痛</option>
                </select>
            </span>
            <label>肾脏</label>
            <select name="kidneys">
                <option>未触及</option>
                <option>可触及</option>
                <option>肿大</option>
            </select>
        </div>
        <div class="form-row">
            <strong>四肢检查：</strong>
            <label>肌力</label>
            <select onchange="toggleDisplay('muscle-strength-detail', this.value)" name="muscle_strength">
                <option>正常(5级)</option>
                <option>异常</option>
            </select>
            <span id="muscle-strength-detail" class="hidden">
                <label>部位</label>
                <select name="muscle_strength_location">
                    <option>双上肢</option>
                    <option>左上肢</option>
                    <option>右上肢</option>
                    <option>双下肢</option>
                    <option>左下肢</option>
                    <option>右下肢</option>
                    <option>四肢</option>
                </select>
                <label>级别</label>
                <select name="muscle_strength_grade">
                    <option>4级</option>
                    <option>3级</option>
                    <option>2级</option>
                    <option>1级</option>
                    <option>0级</option>
                </select>
            </span>
            <label>肌张力</label>
            <select name="muscle_tone">
                <option>正常</option>
                <option>增高</option>
                <option>减低</option>
                <option>松弛</option>
            </select>
            <label>关节活动</label>
            <select onchange="toggleDisplay('joint-detail', this.value)" name="joint_mobility">
                <option>正常</option>
                <option>异常</option>
            </select>
            <span id="joint-detail" class="hidden">
                <label>部位</label>
                <input type="text" placeholder="如膝关节、肘关节等" name="joint_location">
                <label>情况</label>
                <select name="joint_condition">
                    <option>活动受限</option>
                    <option>僵硬</option>
                    <option>畸形</option>
                    <option>肿胀</option>
                    <option>疼痛</option>
                </select>
            </span>
        </div>
        <div class="form-row">
            <strong>神经系统：</strong>
            <label>生理反射</label>
            <select name="physiological_reflex">
                <option>正常</option>
                <option>活跃</option>
                <option>减弱</option>
                <option>消失</option>
            </select>
            <label>病理反射</label>
            <select name="pathological_reflex">
                <option>阴性</option>
                <option>巴氏征阳性</option>
                <option>其他病理征阳性</option>
            </select>
            <label>脑膜刺激征</label>
            <select name="meningeal_signs">
                <option>阴性</option>
                <option>颈强直</option>
                <option>Kernig征阳性</option>
                <option>Brudzinski征阳性</option>
            </select>
        </div>
        </div>
    </div>

    <!-- 辅助检查 -->
    <div class="section">
        <h2>辅助检查</h2>
        <div class="section-content">
        <div class="form-row">
            <strong>实验室检查：</strong>
            <label>血常规</label>
            <select onchange="toggleDisplay('blood-test', this.value)">
                <option>未查</option>
                <option>已查</option>
            </select>
            <span id="blood-test" class="hidden">
                <textarea rows="2" placeholder="血常规结果"></textarea>
            </span>
        </div>
        <div class="form-row">
            <label>尿常规</label>
            <select onchange="toggleDisplay('urine-test', this.value)">
                <option>未查</option>
                <option>已查</option>
            </select>
            <span id="urine-test" class="hidden">
                <textarea rows="2" placeholder="尿常规结果"></textarea>
            </span>
        </div>
        <div class="form-row">
            <label>肝功能</label>
            <select onchange="toggleDisplay('liver-test', this.value)">
                <option>未查</option>
                <option>已查</option>
            </select>
            <span id="liver-test" class="hidden">
                <textarea rows="2" placeholder="肝功能结果"></textarea>
            </span>
        </div>
        <div class="form-row">
            <label>肾功能</label>
            <select onchange="toggleDisplay('kidney-test', this.value)">
                <option>未查</option>
                <option>已查</option>
            </select>
            <span id="kidney-test" class="hidden">
                <textarea rows="2" placeholder="肾功能结果"></textarea>
            </span>
        </div>
        <div class="form-row">
            <strong>影像学检查：</strong>
            <label>X线</label>
            <select onchange="toggleDisplay('xray-test', this.value)">
                <option>未查</option>
                <option>已查</option>
            </select>
            <span id="xray-test" class="hidden">
                <textarea rows="2" placeholder="X线检查结果"></textarea>
            </span>
        </div>
        <div class="form-row">
            <label>CT</label>
            <select onchange="toggleDisplay('ct-test', this.value)">
                <option>未查</option>
                <option>已查</option>
            </select>
            <span id="ct-test" class="hidden">
                <textarea rows="2" placeholder="CT检查结果"></textarea>
            </span>
        </div>
        <div class="form-row">
            <label>MRI</label>
            <select onchange="toggleDisplay('mri-test', this.value)">
                <option>未查</option>
                <option>已查</option>
            </select>
            <span id="mri-test" class="hidden">
                <textarea rows="2" placeholder="MRI检查结果"></textarea>
            </span>
        </div>
        <div class="form-row">
            <label>超声</label>
            <select onchange="toggleDisplay('ultrasound-test', this.value)">
                <option>未查</option>
                <option>已查</option>
            </select>
            <span id="ultrasound-test" class="hidden">
                <textarea rows="2" placeholder="超声检查结果"></textarea>
            </span>
        </div>
        <div class="form-row">
            <strong>其他检查：</strong>
            <textarea rows="2" placeholder="心电图、内镜、病理等其他检查"></textarea>
        </div>
        </div>
    </div>

    <!-- 操作按钮 -->
    <div class="section" style="text-align: center;">
        <button type="button" onclick="saveForm()" style="background-color: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-size: 14px; cursor: pointer; margin: 5px;">💾 保存到本地</button>
        <button type="button" onclick="clearForm()" style="background-color: #95a5a6; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-size: 14px; cursor: pointer; margin: 5px;">🗑️ 清空表单</button>
        <button type="button" onclick="loadTemplate()" style="background-color: #f39c12; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-size: 14px; cursor: pointer; margin: 5px;">📋 加载模板</button>
        <button type="button" onclick="exportToWord()" style="background-color: #2980b9; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-size: 14px; cursor: pointer; margin: 5px;">📝 导出Word</button>
        <button type="button" onclick="restoreForm()" style="background-color: #27ae60; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-size: 14px; cursor: pointer; margin: 5px;">🔄 恢复数据</button>
        
        <div style="margin-top: 20px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; font-size: 12px; color: #666;">
            <p><strong>💡 使用提示：</strong></p>
            <p>• 点击各模块标题可折叠/展开内容</p>
            <p>• 系统回顾中选择"有"会显示详细输入框</p>
            <p>• 既往史疾病用药支持多种药物选择</p>
            <p>• 生育史根据是否有生育经历智能显示相关内容</p>
            <p>• 导出Word文档使用中文字段名，便于阅读</p>
        </div>
    </div>
</body>
</html>
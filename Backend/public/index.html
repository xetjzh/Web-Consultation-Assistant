<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»ç–—é—®è¯ŠåŠ©æ‰‹ - æ¼”ç¤ºé¡µé¢</title>
    <link rel="stylesheet" href="/css/navigation.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        body.has-nav {
            padding-top: 70px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .section {
            background: white;
            margin-bottom: 2rem;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 1rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .status-ok {
            border-color: #28a745;
            background-color: #d4edda;
            color: #155724;
        }

        .status-error {
            border-color: #dc3545;
            background-color: #f8d7da;
            color: #721c24;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ccc;
            animation: pulse 2s infinite;
        }

        .status-indicator.online {
            background-color: #28a745;
        }

        .status-indicator.offline {
            background-color: #dc3545;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .demo-section {
            border: 2px dashed #667eea;
            background: #f8f9ff;
        }

        .instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .form-group {
                min-width: 100%;
            }
        }
    </style>
</head>
<body class="has-nav">
    <div id="navigation"></div>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ åŒ»ç–—é—®è¯ŠåŠ©æ‰‹</h1>
            <p>åç«¯æ•°æ®åº“é›†æˆæ¼”ç¤ºç³»ç»Ÿ</p>
        </div>

        <!-- APIçŠ¶æ€æ£€æŸ¥ -->
        <div class="section">
            <h2>ğŸ”— ç³»ç»ŸçŠ¶æ€</h2>
            <div class="status-panel" id="api-status">
                <div class="api-status">
                    <div class="status-indicator" id="status-indicator"></div>
                    <span id="status-text">æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨è¿æ¥...</span>
                </div>
            </div>
            <button class="btn" onclick="checkServerStatus()">é‡æ–°æ£€æŸ¥è¿æ¥</button>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="section demo-section">
            <h2>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h2>
            <div class="instructions">
                <strong>æ¼”ç¤ºæ­¥éª¤ï¼š</strong>
                <ol>
                    <li>ç¡®ä¿åç«¯æœåŠ¡å™¨è¿è¡Œæ­£å¸¸ï¼ˆç»¿è‰²æŒ‡ç¤ºç¯ï¼‰</li>
                    <li>å¡«å†™æ‚£è€…åŸºæœ¬ä¿¡æ¯</li>
                    <li>å¡«å†™ç—‡çŠ¶è¯¦æƒ…ï¼ˆç°ç—…å²ï¼‰</li>
                    <li>å®Œæˆç³»ç»Ÿå›é¡¾</li>
                    <li>ç‚¹å‡»"ä¿å­˜åˆ°æ•°æ®åº“"æµ‹è¯•åŠŸèƒ½</li>
                </ol>
                <p><strong>æ³¨æ„ï¼š</strong> éœ€è¦å…ˆé…ç½®MySQLæ•°æ®åº“è¿æ¥æ‰èƒ½å®Œæ•´æµ‹è¯•æ•°æ®å­˜å‚¨åŠŸèƒ½ã€‚</p>
            </div>
        </div>

        <!-- æ‚£è€…åŸºæœ¬ä¿¡æ¯ -->
        <div class="section">
            <h2>ğŸ‘¤ æ‚£è€…åŸºæœ¬ä¿¡æ¯</h2>
            <form id="patient-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="patient-name">å§“å *</label>
                        <input type="text" id="patient-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="patient-age">å¹´é¾„ *</label>
                        <input type="number" id="patient-age" name="age" min="0" max="150" required>
                    </div>
                    <div class="form-group">
                        <label for="patient-gender">æ€§åˆ« *</label>
                        <select id="patient-gender" name="gender" required>
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="phone">è”ç³»ç”µè¯</label>
                        <input type="tel" id="phone" name="phone">
                    </div>
                    <div class="form-group">
                        <label for="medical-record-number">ç—…å†å·</label>
                        <input type="text" id="medical-record-number" name="medicalRecordNumber">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="chief-complaint">ä¸»è¯‰ *</label>
                        <textarea id="chief-complaint" name="chiefComplaint" placeholder="è¯·è¯¦ç»†æè¿°ä¸»è¦ç—‡çŠ¶..." required></textarea>
                    </div>
                </div>
            </form>
        </div>

        <!-- ç°ç—…å² -->
        <div class="section">
            <h2>ğŸ“ ç°ç—…å²</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="symptom-details">ç—‡çŠ¶è¯¦æƒ…</label>
                    <textarea id="symptom-details" placeholder="è¯¦ç»†æè¿°ç—‡çŠ¶çš„å‘ç”Ÿã€å‘å±•è¿‡ç¨‹..."></textarea>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="duration">æŒç»­æ—¶é—´</label>
                    <input type="text" id="duration" placeholder="å¦‚ï¼š3å¤©ã€1å‘¨ç­‰">
                </div>
                <div class="form-group">
                    <label for="severity">ä¸¥é‡ç¨‹åº¦</label>
                    <select id="severity">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="è½»åº¦">è½»åº¦</option>
                        <option value="ä¸­åº¦">ä¸­åº¦</option>
                        <option value="é‡åº¦">é‡åº¦</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿå›é¡¾ï¼ˆç®€åŒ–ç‰ˆï¼‰ -->
        <div class="section">
            <h2>ğŸ” ç³»ç»Ÿå›é¡¾</h2>
            <div class="form-row">
                <strong>ç¥ç»ç³»ç»Ÿç—‡çŠ¶ï¼š</strong>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>å¤´ç—›</label>
                    <select data-system="nervous" data-symptom="headache">
                        <option value="æ— ">æ— </option>
                        <option value="æœ‰">æœ‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¤´æ™•</label>
                    <select data-system="nervous" data-symptom="dizziness">
                        <option value="æ— ">æ— </option>
                        <option value="æœ‰">æœ‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¤±çœ </label>
                    <select data-system="nervous" data-symptom="insomnia">
                        <option value="æ— ">æ— </option>
                        <option value="æœ‰">æœ‰</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="section">
            <h2>ğŸ’¾ æ•°æ®æ“ä½œ</h2>
            <div style="text-align: center;">
                <button class="btn" onclick="savePatientData()" id="save-btn">
                    ä¿å­˜åˆ°æ•°æ®åº“
                </button>
                <button class="btn" onclick="loadSampleData()">
                    åŠ è½½ç¤ºä¾‹æ•°æ®
                </button>
                <button class="btn" onclick="clearForm()">
                    æ¸…ç©ºè¡¨å•
                </button>
            </div>
        </div>

        <!-- æµ‹è¯•ç»“æœæ˜¾ç¤º -->
        <div class="section">
            <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
            <div id="test-results" class="status-panel">
                <p>ç­‰å¾…æ“ä½œ...</p>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥APIé›†æˆæ–‡ä»¶ -->
    <script src="/js/medical-api.js"></script>
    
    <script>
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkServerStatus();
            loadSampleData();
        });

        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkServerStatus() {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const statusPanel = document.getElementById('api-status');

            try {
                // æ›´æ–°APIåŸºç¡€URL
                medicalAPI.baseURL = 'http://localhost:3001/api';
                
                const response = await medicalAPI.healthCheck();
                
                statusIndicator.classList.add('online');
                statusIndicator.classList.remove('offline');
                statusText.textContent = `æœåŠ¡å™¨è¿æ¥æ­£å¸¸ - ${response.message}`;
                statusPanel.classList.add('status-ok');
                statusPanel.classList.remove('status-error');
                
            } catch (error) {
                statusIndicator.classList.add('offline');
                statusIndicator.classList.remove('online');
                statusText.textContent = `æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.message}`;
                statusPanel.classList.add('status-error');
                statusPanel.classList.remove('status-ok');
            }
        }

        // åŠ è½½ç¤ºä¾‹æ•°æ®
        function loadSampleData() {
            document.getElementById('patient-name').value = 'å¼ ä¸‰';
            document.getElementById('patient-age').value = '35';
            document.getElementById('patient-gender').value = 'ç”·';
            document.getElementById('phone').value = '13800138001';
            document.getElementById('medical-record-number').value = 'MR2024001';
            document.getElementById('chief-complaint').value = 'å¤´ç—›3å¤©ï¼Œä¼´æœ‰æ¶å¿ƒå‘•å';
            document.getElementById('symptom-details').value = 'æ‚£è€…3å¤©å‰æ— æ˜æ˜¾è¯±å› å‡ºç°å¤´ç—›ï¼Œå‘ˆæŒç»­æ€§èƒ€ç—›ï¼Œä¼´æœ‰æ¶å¿ƒå‘•åï¼Œä¼‘æ¯åç¨æœ‰ç¼“è§£';
            document.getElementById('duration').value = '3å¤©';
            document.getElementById('severity').value = 'ä¸­åº¦';
            
            showResult('ç¤ºä¾‹æ•°æ®å·²åŠ è½½', 'info');
        }

        // ä¿å­˜æ‚£è€…æ•°æ®
        async function savePatientData() {
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';

            try {
                // æ”¶é›†åŸºæœ¬ä¿¡æ¯
                const basicInfo = {
                    name: document.getElementById('patient-name').value,
                    age: parseInt(document.getElementById('patient-age').value),
                    gender: document.getElementById('patient-gender').value,
                    phone: document.getElementById('phone').value,
                    medicalRecordNumber: document.getElementById('medical-record-number').value,
                    chiefComplaint: document.getElementById('chief-complaint').value
                };

                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!basicInfo.name || !basicInfo.age || !basicInfo.gender || !basicInfo.chiefComplaint) {
                    throw new Error('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼ˆå§“åã€å¹´é¾„ã€æ€§åˆ«ã€ä¸»è¯‰ï¼‰');
                }

                showResult('æ­£åœ¨ä¿å­˜æ‚£è€…åŸºæœ¬ä¿¡æ¯...', 'info');

                // ä¿å­˜æ‚£è€…åŸºæœ¬ä¿¡æ¯
                const patientResponse = await medicalAPI.savePatientBasicInfo(basicInfo);
                const patientId = patientResponse.patientId;

                showResult(`æ‚£è€…ä¿¡æ¯ä¿å­˜æˆåŠŸï¼Œæ‚£è€…ID: ${patientId}`, 'success');

                // å¦‚æœæœ‰ç°ç—…å²ä¿¡æ¯ï¼Œä¹Ÿä¿å­˜
                const illnessData = {
                    symptomDetails: document.getElementById('symptom-details').value,
                    duration: document.getElementById('duration').value,
                    severity: document.getElementById('severity').value
                };

                if (illnessData.symptomDetails) {
                    await medicalAPI.saveCurrentIllness(patientId, illnessData);
                    showResult('ç°ç—…å²ä¿å­˜æˆåŠŸ', 'success');
                }

                // ä¿å­˜ç³»ç»Ÿå›é¡¾
                const systemReview = formHandler.collectSystemReview();
                await medicalAPI.saveSystemReview(patientId, systemReview);
                showResult('ç³»ç»Ÿå›é¡¾ä¿å­˜æˆåŠŸ', 'success');

                showResult('âœ… æ‰€æœ‰æ•°æ®ä¿å­˜å®Œæˆï¼', 'success');

            } catch (error) {
                console.error('ä¿å­˜æ•°æ®é”™è¯¯:', error);
                showResult(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'ä¿å­˜åˆ°æ•°æ®åº“';
            }
        }

        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            document.getElementById('patient-form').reset();
            document.getElementById('symptom-details').value = '';
            document.getElementById('duration').value = '';
            document.getElementById('severity').value = '';
            
            const systemSelects = document.querySelectorAll('[data-system]');
            systemSelects.forEach(select => {
                select.value = 'æ— ';
            });
            
            showResult('è¡¨å•å·²æ¸…ç©º', 'info');
        }

        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function showResult(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            
            const colors = {
                success: '#d4edda',
                error: '#f8d7da',
                warning: '#fff3cd',
                info: '#d1ecf1'
            };

            resultsDiv.style.backgroundColor = colors[type];
            resultsDiv.innerHTML = `
                <p><strong>[${timestamp}]</strong> ${message}</p>
            `;
        }
    </script>
    <script src="/js/navigation.js"></script>
</body>
</html>
